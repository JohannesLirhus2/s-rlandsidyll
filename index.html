<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Sørlandsidyll - Oppskrifter</title>
<link rel="icon" type="image/png" href="assets/lime.png"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script type="module" src="assets/component-loader.js"></script>
<script src="assets/scripts.js"></script>
<script src="assets/header.js"></script>
<script type="module" src="assets/firebase.js"></script>
<script type="module" src="assets/auth.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700;900&amp;family=Playfair+Display:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<link href="assets/styles.css" rel="stylesheet"/>
<style>
  .tag-filter-active-banner:hover {
    background-color: #0d7d74;
  }
  
  /* Mobile header - fixed positioning */
  @media (max-width: 768px) {
    header {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
    }
    
    body {
      padding-top: 64px; /* h-16 = 64px */
    }
    
    #searchButton {
      display: none !important;
    }
    
    dialog {
      max-width: calc(100vw - 2rem) !important;
      max-height: calc(100vh - 2rem);
      margin: 1rem;
      width: calc(100vw - 2rem) !important;
    }
    dialog::backdrop {
      background: rgba(0, 0, 0, 0.5);
    }
  }
</style>
</head>
<body class="antialiased overflow-x-hidden">
<div id="header-placeholder"></div>

<main>
<section class="relative bg-slate-900 overflow-hidden border-b border-slate-200">
<div class="absolute inset-0 z-0 opacity-40">
<img alt="Sørlandsidyll mat" class="w-full h-full object-cover" src="assets/skibbu.webp"/>
</div>
<div class="relative z-10 max-w-7xl mx-auto px-4 py-12 md:py-16 text-center">
<h1 class="text-4xl md:text-5xl font-bold text-white mb-6" style="display: none;">Smaken av <span class="italic text-accent">Sørlandet</span></h1>
<img src="assets/logo-white.png" alt="Sørlandsidyll" class="mx-auto mb-6 h-auto" style="width: 300px;"/>
<div class="max-w-2xl mx-auto">
<div class="relative flex items-center bg-white rounded-xl shadow-xl overflow-hidden p-1 border border-slate-200">
<span class="material-symbols-outlined text-slate-400 ml-4">search</span>
<input id="searchInput" class="flex-1 border-none focus:ring-0 text-slate-800 placeholder:text-slate-400 font-display px-4 py-3" placeholder="Søk i våre oppskrifter..." type="text"/>
<button id="searchButton" class="hidden md:block bg-accent text-white px-6 py-3 rounded-lg font-bold text-sm uppercase tracking-wide hover:bg-accent-hover transition-colors">Finn oppskrift</button>
<button id="banner-new-recipe-button" class="hidden bg-slate-200 hover:bg-slate-300 text-slate-800 px-6 py-3 rounded-lg font-bold text-sm uppercase tracking-wide transition-colors ml-2" onclick="window.location.href='#'">Ny oppskrift</button>
</div>
<div class="mt-6 flex flex-wrap justify-center gap-2">
<span class="text-white/70 text-xs font-bold uppercase tracking-widest mr-2 py-1">Populære:</span>
<div id="banner-filters-container">
<!-- Banner filters will be loaded from Firebase -->
</div>
</div>
</div>
</div>
</section>
<section class="py-12 max-w-7xl mx-auto px-4">
<div class="flex flex-col lg:flex-row lg:items-center justify-between mb-8 border-b border-slate-100 pb-6 gap-6">
<div>
<h2 class="text-2xl font-bold text-slate-900">Siste oppskrifter</h2>
<p class="text-slate-500 text-sm font-display mt-1">Oppdag våre nyeste kreasjoner inspirert av bølgeskvulp og varme svaberg.</p>
</div>
<div class="flex items-center gap-2 overflow-x-auto hide-scrollbar pb-2 lg:pb-0">
<button id="tagFilter-all" class="whitespace-nowrap px-4 py-1.5 bg-accent text-white rounded-lg text-xs font-bold uppercase tracking-wider">Alt</button>
<div id="main-filters-container" class="flex items-center gap-2">
<!-- Main filters will be loaded from Firebase -->
</div>
</div>
</div>
<div id="recipesContainer" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
<!-- Recipes will be loaded here from Firebase -->
</div>
<div class="mt-12 text-center">
<a href="oppskrifter.html" class="inline-flex items-center gap-2 text-primary font-bold text-xs uppercase tracking-widest hover:text-accent transition-colors">
                Se alle oppskrifter
                <span class="material-symbols-outlined text-sm">arrow_forward</span>
</a>
</div>
</section>
<section class="hidden py-12 bg-slate-50">
<div class="max-w-7xl mx-auto px-4">
<div class="flex items-center justify-between mb-8">
<h2 class="text-xl font-bold text-slate-900">Sesongens råvarer</h2>
<div class="flex gap-2">
<button class="w-8 h-8 rounded-full border border-slate-200 flex items-center justify-center text-slate-400 hover:bg-white hover:text-accent transition-all">
<span class="material-symbols-outlined text-sm">chevron_left</span>
</button>
<button class="w-8 h-8 rounded-full border border-slate-200 flex items-center justify-center text-slate-400 hover:bg-white hover:text-accent transition-all">
<span class="material-symbols-outlined text-sm">chevron_right</span>
</button>
</div>
</div>
<div class="flex gap-4 overflow-x-auto hide-scrollbar pb-4 -mx-4 px-4">
<div class="flex-none w-64 md:w-80 bg-white p-6 rounded-xl border border-slate-100 flex gap-4 items-start shadow-sm">
<div class="w-12 h-12 rounded-lg bg-accent/10 flex items-center justify-center text-accent flex-shrink-0">
<span class="material-symbols-outlined">energy_savings_leaf</span>
</div>
<div>
<h3 class="text-sm font-bold text-slate-900 mb-1 font-display">Norske Asparges</h3>
<p class="text-slate-500 text-[11px] leading-relaxed font-display">Sprø og smaksrike, perfekte som tilbehør eller i en frisk salat.</p>
</div>
</div>
<div class="flex-none w-64 md:w-80 bg-white p-6 rounded-xl border border-slate-100 flex gap-4 items-start shadow-sm">
<div class="w-12 h-12 rounded-lg bg-accent/10 flex items-center justify-center text-accent flex-shrink-0">
<span class="material-symbols-outlined">set_meal</span>
</div>
<div>
<h3 class="text-sm font-bold text-slate-900 mb-1 font-display">Sørlandsmakrell</h3>
<p class="text-slate-500 text-[11px] leading-relaxed font-display">Fet og næringsrik fisk, aller best når den grilles ute.</p>
</div>
</div>
<div class="flex-none w-64 md:w-80 bg-white p-6 rounded-xl border border-slate-100 flex gap-4 items-start shadow-sm">
<div class="w-12 h-12 rounded-lg bg-accent/10 flex items-center justify-center text-accent flex-shrink-0">
<span class="material-symbols-outlined">icecream</span>
</div>
<div>
<h3 class="text-sm font-bold text-slate-900 mb-1 font-display">Søte Jordbær</h3>
<p class="text-slate-500 text-[11px] leading-relaxed font-display">Søte, røde fristelser modnet i kystvinden under sola.</p>
</div>
</div>
</div>
</div>
</section>
<section class="hidden py-16 max-w-5xl mx-auto px-4">
<div class="bg-primary rounded-2xl p-8 md:p-16 text-center text-white shadow-2xl">
<h2 class="text-3xl font-bold italic mb-4">Bli en del av fellesskapet</h2>
<p class="text-slate-300 text-sm max-w-lg mx-auto font-display mb-10">
                Få ukentlige oppskrifter, tips om lokale råvarer og historier fra skjærgården rett i innboksen din.
            </p>
<form class="max-w-md mx-auto flex flex-col sm:flex-row gap-2">
<input class="flex-1 bg-white/10 border border-white/20 rounded-lg px-5 py-3 text-white placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-accent font-display text-sm" placeholder="Din e-postadresse" type="email"/>
<button class="bg-accent text-white font-bold px-8 py-3 rounded-lg hover:bg-teal-700 transition-colors text-sm uppercase tracking-wider">Abonner</button>
</form>
</div>
</section>
</main>

<div id="footer-placeholder"></div>

<script type="module">
import { db } from './assets/firebase.js';
import { collection, getDocs } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js';

// Global map for author username -> public name
let authorsMap = {};

// Load authors collection
async function loadAuthors() {
    try {
        const authorsRef = collection(db, 'authors');
        const authorsSnapshot = await getDocs(authorsRef);
        
        authorsSnapshot.forEach((doc) => {
            const authorId = doc.id;
            const authorData = doc.data();
            const publicName = authorData['public-name'] || authorData.public_name || authorId;
            authorsMap[authorId] = publicName;
        });
        
        console.log('Authors loaded:', Object.keys(authorsMap).length);
    } catch (error) {
        console.error('Error loading authors:', error);
    }
}

// Load filters from cathegories collection
async function loadFilters() {
    try {
        const categoriesRef = collection(db, 'cathegories');
        const categoriesSnapshot = await getDocs(categoriesRef);
        
        const bannerContainer = document.getElementById('banner-filters-container');
        const mainContainer = document.getElementById('main-filters-container');
        
        let bannerCount = 0;
        const maxBannerCategories = 3;
        
        categoriesSnapshot.forEach((doc) => {
            const categoryData = doc.data();
            const categoryId = doc.id; // e.g., "tbakst"
            const categoryName = categoryData.name; // e.g., "Bakst"
            const isActive = categoryData.active || false;
            
            // Store in categoriesMap for displaying category names
            categoriesMap[categoryId] = categoryName;
            console.log('Stored in map:', categoryId, '->', categoryName);
            
            if (!isActive) return; // Skip inactive categories
            
            // Create banner filter button (max 3 under "populære")
            if (bannerContainer && bannerCount < maxBannerCategories) {
                const bannerBtn = document.createElement('button');
                bannerBtn.className = 'tag-filter px-3 py-1 bg-white/10 hover:bg-white/20 text-white rounded-full text-xs font-medium transition-colors border border-white/20';
                bannerBtn.setAttribute('data-tag', categoryId.substring(1)); // Remove 't' prefix
                bannerBtn.setAttribute('data-banner', 'true');
                bannerBtn.textContent = categoryName;
                bannerContainer.appendChild(bannerBtn);
                bannerCount++;
            }
            
            // Create main section filter button (all active categories)
            if (mainContainer) {
                const mainBtn = document.createElement('button');
                mainBtn.className = 'tag-filter whitespace-nowrap px-4 py-1.5 bg-slate-100 text-slate-600 hover:bg-slate-200 rounded-lg text-xs font-bold uppercase tracking-wider transition-colors';
                mainBtn.setAttribute('data-tag', categoryId.substring(1)); // Remove 't' prefix
                mainBtn.textContent = categoryName;
                mainContainer.appendChild(mainBtn);
            }
        });
    } catch (error) {
        console.error('Error loading filters:', error);
    }
    console.log('Final categoriesMap:', categoriesMap);
}

// Load data on page load
(async function() {
    await loadAuthors();
    await loadFilters();
    await loadRecipes();
    setupFilterHandlers(); // Set up click handlers after filters are loaded
})();

// Store all recipes globally for filtering
let allRecipes = [];
let currentFilter = null; // null means show all
let categoriesMap = {}; // Map category ID to name

// Load recipes
async function loadRecipes() {
    try {
        const recipesContainer = document.getElementById('recipesContainer');
        if (!recipesContainer) return;
        
        recipesContainer.innerHTML = '<p class="col-span-full text-center text-slate-500">Laster oppskrifter...</p>';
        
        const recipesRef = collection(db, 'recipes');
        const snapshot = await getDocs(recipesRef);
        
        if (snapshot.empty) {
            recipesContainer.innerHTML = '<p class="col-span-full text-center text-slate-500">Ingen oppskrifter funnet</p>';
            return;
        }
        
        // Store all recipes for filtering
        allRecipes = [];
        
        snapshot.forEach((doc) => {
            const recipe = doc.data();
            const recipeId = doc.id;
            
            // Skip deleted recipes
            if (recipe.deleted === true) return;
            
            // Store recipe with its ID
            allRecipes.push({
                id: recipeId,
                ...recipe
            });
        });
        
        console.log('Total recipes loaded:', allRecipes.length);
        
        // Log first recipe to see structure
        if (allRecipes.length > 0) {
            console.log('Sample recipe structure:', allRecipes[0]);
            console.log('Sample recipe categories field:', allRecipes[0].categories);
        }
        
        // Display filtered or all recipes
        displayFilteredRecipes();
    } catch (error) {
        console.error('Error loading recipes:', error);
        const recipesContainer = document.getElementById('recipesContainer');
        if (recipesContainer) {
            recipesContainer.innerHTML = '<p class="col-span-full text-center text-red-500">Kunne ikke laste oppskrifter</p>';
        }
    }
}

// Display recipes based on current filter
function displayFilteredRecipes() {
    const recipesContainer = document.getElementById('recipesContainer');
    if (!recipesContainer) return;
    
    recipesContainer.innerHTML = '';
    
    // Filter recipes based on currentFilter
    let recipesToShow = allRecipes;
    if (currentFilter) {
        const filterCategoryId = 't' + currentFilter; // e.g., 'tbakst'
        console.log('Filtering by ID:', filterCategoryId);
        recipesToShow = allRecipes.filter(recipe => {
            console.log('Recipe:', recipe.title, 'has categories:', recipe.categories, 'category:', recipe.category);
            
            // Check categories array (new format)
            if (recipe.categories && Array.isArray(recipe.categories) && recipe.categories.length > 0) {
                const hasMatch = recipe.categories.some(cat => {
                    let categoryId = typeof cat === 'string' ? cat : cat.category;
                    
                    console.log('Checking category (array):', cat, 'extracted:', categoryId, 'looking for:', filterCategoryId);
                    
                    if (categoryId && !categoryId.startsWith('t')) {
                        categoryId = 't' + categoryId;
                    }
                    
                    return categoryId === filterCategoryId;
                });
                console.log('Recipe', recipe.title, 'match (array):', hasMatch);
                return hasMatch;
            }
            // Check singular category field (old format)
            else if (recipe.category) {
                let categoryId = recipe.category;
                console.log('Checking category (singular):', categoryId, 'looking for:', filterCategoryId);
                
                if (categoryId && !categoryId.startsWith('t')) {
                    categoryId = 't' + categoryId;
                }
                
                const hasMatch = categoryId === filterCategoryId;
                console.log('Recipe', recipe.title, 'match (singular):', hasMatch);
                return hasMatch;
            }
            
            console.log('Recipe', recipe.title, 'has no category data');
            return false;
        });
        console.log('Filtering by:', currentFilter, '- Found:', recipesToShow.length, 'recipes');
    }
    
    if (recipesToShow.length === 0) {
        recipesContainer.innerHTML = '<p class="col-span-full text-center text-slate-500">Ingen oppskrifter funnet for denne kategorien</p>';
        return;
    }
    
    // Limit to 8 recipes for homepage
    const maxRecipes = 8;
    let count = 0;
    
    recipesToShow.forEach((recipe) => {
        if (count >= maxRecipes) return;
        
        console.log('✓ Displaying recipe:', recipe.title, 'categories:', recipe.categories);
        
        const recipeLink = document.createElement('a');
        recipeLink.href = `oppskrift.html?id=${recipe.id}`;
        recipeLink.className = 'block bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-lg transition-all duration-300 group';
        
        const imgUrl = recipe.img_url || 'https://via.placeholder.com/300x200?text=Ingen+bilde';
        
        // Get author display name
        const authorDisplayName = recipe.author ? (authorsMap[recipe.author] || recipe.author) : 'Ukjent forfatter';
        
        // Get first category name
        let categoryName = '';
        
        // Check categories array first (new format)
        if (recipe.categories && Array.isArray(recipe.categories) && recipe.categories.length > 0) {
            const firstCategory = recipe.categories[0];
            let categoryId = typeof firstCategory === 'string' ? firstCategory : firstCategory.category;
            
            console.log('Recipe:', recipe.title, 'Category data (array):', firstCategory, 'Extracted ID:', categoryId);
            
            // Ensure categoryId has 't' prefix for lookup
            if (categoryId && !categoryId.startsWith('t')) {
                categoryId = 't' + categoryId;
            }
            
            categoryName = categoriesMap[categoryId] || '';
            console.log('Looking up:', categoryId, 'Found:', categoryName);
        }
        // Fall back to singular category field (old format)
        else if (recipe.category) {
            let categoryId = recipe.category;
            console.log('Recipe:', recipe.title, 'Category data (singular):', categoryId);
            
            // Ensure categoryId has 't' prefix for lookup
            if (categoryId && !categoryId.startsWith('t')) {
                categoryId = 't' + categoryId;
            }
            
            categoryName = categoriesMap[categoryId] || '';
            console.log('Looking up:', categoryId, 'Found:', categoryName);
        }
        
        recipeLink.innerHTML = `
            <div class="aspect-[4/3] bg-slate-100 overflow-hidden">
                <img src="${imgUrl}" alt="${recipe.title || 'Oppskrift'}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">
            </div>
            <div class="p-4">
                <h3 class="font-serif text-lg font-bold text-slate-800 mb-2">${recipe.title || 'Uten tittel'}</h3>
                ${recipe.description ? `<p class="text-xs text-slate-600 mb-3 line-clamp-2">${recipe.description}</p>` : ''}
                <div class="flex items-center justify-between text-xs text-slate-500">
                    <span>${authorDisplayName}</span>
                    ${categoryName ? `<span>${categoryName}</span>` : ''}
                </div>
            </div>
        `;
        
        recipesContainer.appendChild(recipeLink);
        count++;
    });
}

// Setup filter button handlers
function setupFilterHandlers() {
    // Get all filter buttons
    const allButton = document.getElementById('tagFilter-all');
    const tagFilterButtons = document.querySelectorAll('.tag-filter');
    
    console.log('Setting up filter handlers - Found', tagFilterButtons.length, 'filter buttons');
    
    // \"Alt\" button - show all recipes
    if (allButton) {
        allButton.addEventListener('click', function() {
            console.log('All button clicked');
            currentFilter = null;
            displayFilteredRecipes();
            updateFilterButtonStyles(null);
        });
    }
    
    // Tag filter buttons
    tagFilterButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tag = this.getAttribute('data-tag');
            console.log('Filter button clicked:', tag);
            if (tag) {
                currentFilter = tag;
                displayFilteredRecipes();
                updateFilterButtonStyles(tag);
            }
        });
    });
}

// Update button styles to show active filter
function updateFilterButtonStyles(activeTag) {
    const allButton = document.getElementById('tagFilter-all');
    const tagFilterButtons = document.querySelectorAll('.tag-filter');
    
    // Update \"Alt\" button
    if (allButton) {
        if (activeTag === null) {
            allButton.className = 'whitespace-nowrap px-4 py-1.5 bg-accent text-white rounded-lg text-xs font-bold uppercase tracking-wider';
        } else {
            allButton.className = 'whitespace-nowrap px-4 py-1.5 bg-slate-100 text-slate-600 hover:bg-slate-200 rounded-lg text-xs font-bold uppercase tracking-wider transition-colors';
        }
    }
    
    // Update tag filter buttons
    tagFilterButtons.forEach(button => {
        const tag = button.getAttribute('data-tag');
        const isBanner = button.getAttribute('data-banner') === 'true';
        
        if (tag === activeTag) {
            // Active state
            if (isBanner) {
                button.className = 'tag-filter tag-filter-active-banner px-3 py-1 bg-accent text-white rounded-full text-xs font-medium transition-colors border border-accent';
            } else {
                button.className = 'tag-filter whitespace-nowrap px-4 py-1.5 bg-accent text-white rounded-lg text-xs font-bold uppercase tracking-wider';
            }
        } else {
            // Inactive state
            if (isBanner) {
                button.className = 'tag-filter px-3 py-1 bg-white/10 hover:bg-white/20 text-white rounded-full text-xs font-medium transition-colors border border-white/20';
            } else {
                button.className = 'tag-filter whitespace-nowrap px-4 py-1.5 bg-slate-100 text-slate-600 hover:bg-slate-200 rounded-lg text-xs font-bold uppercase tracking-wider transition-colors';
            }
        }
    });
}

// Search functionality (runs on DOMContentLoaded)
document.addEventListener('DOMContentLoaded', function() {
    // Check for search query in URL and populate search fields
    const urlParams = new URLSearchParams(window.location.search);
    const searchQuery = urlParams.get('q');
    if (searchQuery) {
        console.log('Search query from URL:', searchQuery);
        
        // Populate search fields in header (wait for header to load)
        setTimeout(() => {
            const headerSearchInput = document.getElementById('headerSearchInput');
            const mobileSearchInput = document.getElementById('mobileSearchInput');
            const bannerSearchInput = document.getElementById('searchInput');
            
            if (headerSearchInput) {
                headerSearchInput.value = searchQuery;
            }
            if (mobileSearchInput) {
                mobileSearchInput.value = searchQuery;
            }
            if (bannerSearchInput) {
                bannerSearchInput.value = searchQuery;
            }
        }, 100);
    }
    
    // Banner search functionality (specific to index.html)
    function performBannerSearch() {
        const input = document.getElementById('searchInput');
        if (input && input.value.trim()) {
            const searchQuery = encodeURIComponent(input.value.trim());
            window.location.href = `oppskrifter.html?q=${searchQuery}`;
        }
    }

    // Banner search button
    const bannerSearchButton = document.getElementById('searchButton');
    if (bannerSearchButton) {
        bannerSearchButton.addEventListener('click', performBannerSearch);
    }

    // Banner search input - Enter key
    const bannerSearchInput = document.getElementById('searchInput');
    if (bannerSearchInput) {
        bannerSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performBannerSearch();
            }
        });
    }
});

</script>

</body>
</html>