<!DOCTYPE html>
<html lang="no"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Sørlandsidyll - Legg til ny oppskrift</title>
<link rel="icon" type="image/png" href="assets/lime.png"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script type="module" src="assets/component-loader.js"></script>
<script src="assets/scripts.js"></script>
<script src="assets/header.js"></script>
<script type="module" src="assets/firebase.js"></script>
<script type="module" src="assets/auth.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700;900&amp;family=Playfair+Display:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<link href="assets/styles.css" rel="stylesheet"/>
<style>
        body {
            font-family: 'Work Sans', sans-serif;
        }
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .animate-scale-in {
            animation: scaleIn 0.2s ease-out;
        }
        
        /* Mobile header - fixed positioning */
        @media (max-width: 768px) {
            header {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
            }
            
            body {
                padding-top: 64px; /* h-16 = 64px */
            }
            
            dialog {
                max-width: calc(100vw - 2rem) !important;
                max-height: calc(100vh - 2rem);
                margin: 1rem;
                width: calc(100vw - 2rem) !important;
            }
            dialog::backdrop {
                background: rgba(0, 0, 0, 0.5);
            }
        }
    </style>
</head>
<body class="antialiased overflow-x-hidden">
<header class="sticky top-0 z-50 w-full bg-white/95 backdrop-blur-sm border-b border-slate-200">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex items-center justify-between h-16">
<div class="flex items-center gap-6">
<!-- Logo -->
<div class="flex items-center cursor-pointer" onclick="window.location.href='index.html'">
<img src="assets/logo-small.png" alt="Sørlandsidyll" class="h-10 w-auto"/>
</div>
<!-- Header Search Bar -->
<div class="hidden md:flex items-center">
<div class="relative">
<button type="button" id="headerSearchButton" class="material-symbols-outlined text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 text-sm hover:text-accent transition-colors cursor-pointer z-10">search</button>
<input id="headerSearchInput" class="pl-9 pr-4 py-1.5 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-accent focus:border-transparent transition-all outline-none placeholder:text-slate-400 w-64" placeholder="Søk oppskrifter..." type="text"/>
</div>
</div>
<!-- End Left Group -->
</div>
<!-- Desktop Nav -->
<nav class="hidden md:flex items-center gap-2">
<a id="oppskrifter-link" class="text-xs font-semibold uppercase tracking-wider text-slate-600 hover:text-accent transition-colors px-3" href="index.html">alle oppskrifter</a>
<a id="om-oss-link" class="hidden text-xs font-semibold uppercase tracking-wider text-slate-600 hover:text-accent transition-colors px-3" href="#">Om oss</a>
<!-- Logged out buttons -->
<button id="login-button" class="text-xs font-bold px-3 py-1.5 hover:text-accent transition-all uppercase tracking-wider" onclick="window.location.href='login.html'">Logg inn</button>
<!-- Logged in profile menu (hidden by default) -->
<div id="profile-menu-container" class="hidden relative">
<button id="profile-menu-button" class="w-10 h-10 rounded-full bg-slate-200 overflow-hidden flex items-center justify-center hover:ring-2 hover:ring-accent transition-all" style="box-shadow: 0 0 0 1px #d1d5db, 0 0 0 2px #ffffff, 0 0 0 3px #d1d5db">
<img id="profile-menu-image" class="w-full h-full object-cover" alt="Profilbilde"/>
<span id="profile-menu-initials" class="text-xs font-bold text-slate-600"></span>
</button>
<!-- Dropdown menu -->
<div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-slate-200 z-50">
<button id="menu-new-recipe" class="hidden w-full text-left text-sm font-semibold uppercase tracking-wider text-slate-600 hover:bg-slate-50 px-4 py-3 border-b border-slate-200">Ny oppskrift</button>
<button id="menu-edit-recipes" class="hidden w-full text-left text-sm font-semibold uppercase tracking-wider text-slate-600 hover:bg-slate-50 px-4 py-3 border-b border-slate-200">Rediger oppskrifter</button>
<button id="menu-my-account" class="w-full text-left text-sm font-semibold uppercase tracking-wider text-slate-600 hover:bg-slate-50 px-4 py-3 border-b border-slate-200">Min konto</button>
<button id="menu-logout" class="w-full text-left text-sm font-semibold uppercase tracking-wider text-red-600 hover:bg-red-50 px-4 py-3">Logg ut</button>
</div>
</div>
</nav>
<!-- Mobile Menu Icon -->
<button id="mobile-menu-button" class="md:hidden flex items-center p-2 hover:bg-slate-100 rounded-lg transition-colors">
<span class="material-symbols-outlined text-slate-700">menu</span>
</button>
</div>
</div>

<!-- Mobile Menu Overlay -->
<div id="mobile-menu-overlay" class="hidden fixed inset-0 bg-black/50 z-40 md:hidden"></div>

<!-- Mobile Menu Drawer -->
<div id="mobile-menu" class="fixed top-0 right-0 bottom-0 h-screen w-80 shadow-xl transform translate-x-full transition-transform duration-300 z-50 md:hidden" style="background-color: #ffffff;">
<div class="flex flex-col h-full">
<!-- Mobile Menu Header -->
<div class="flex items-center justify-between px-4 py-4 border-b border-slate-200">
<h2 class="text-lg font-bold text-slate-800">Meny</h2>
<button id="close-mobile-menu" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
<span class="material-symbols-outlined text-slate-700">close</span>
</button>
</div>

<!-- Mobile Search -->
<div class="px-4 py-3 border-b border-slate-200">
<div class="relative">
<span class="material-symbols-outlined text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 text-sm">search</span>
<input id="mobileSearchInput" class="w-full pl-9 pr-4 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-accent focus:border-transparent transition-all outline-none placeholder:text-slate-400" placeholder="Søk oppskrifter..." type="text"/>
</div>
</div>

<!-- Mobile Navigation Links -->
<nav class="flex-1 overflow-y-auto bg-white">
<!-- Always visible: Alle oppskrifter -->
<a href="index.html" class="block px-4 py-3 text-sm font-semibold uppercase tracking-wider text-slate-600 hover:bg-slate-50 border-b border-slate-200">Alle oppskrifter</a>

<!-- Login button (visible when logged out) -->
<a id="mobile-login-button" href="login.html" class="block px-4 py-3 text-sm font-semibold uppercase tracking-wider text-accent hover:bg-slate-50 border-b border-slate-200">Logg inn</a>

<!-- Profile Section (visible when logged in) -->
<div id="mobile-profile-section" class="hidden">
<!-- Profile Header with Avatar (Clickable Toggle) -->
<button id="mobile-profile-toggle" class="w-full px-4 py-3 border-b border-slate-200 bg-slate-50 hover:bg-slate-100 transition-colors">
<div class="flex items-center gap-3">
<div id="mobile-profile-avatar" class="w-12 h-12 rounded-full bg-slate-200 overflow-hidden flex items-center justify-center" style="box-shadow: 0 0 0 1px #d1d5db">
<img id="mobile-profile-image" class="w-full h-full object-cover hidden" alt="Profilbilde"/>
<span id="mobile-profile-initials" class="text-sm font-bold text-slate-600"></span>
</div>
<div class="flex-1 min-w-0 text-left">
<p id="mobile-profile-name" class="text-sm font-semibold text-slate-800 truncate"></p>
<p class="text-xs text-slate-500">Innlogget</p>
</div>
<span id="mobile-profile-chevron" class="material-symbols-outlined text-slate-400 transition-transform duration-200">expand_more</span>
</div>
</button>
<!-- Profile Submenu Items (Hidden by default) -->
<div id="mobile-profile-submenu" class="hidden bg-slate-50">
<a id="mobile-menu-new-recipe" href="ny-oppskrift.html" class="hidden block px-4 py-3 pl-8 text-sm font-semibold uppercase tracking-wider text-slate-600 hover:bg-slate-100 border-b border-slate-200">Ny oppskrift</a>
<a id="mobile-menu-my-recipes" href="#" class="block px-4 py-3 pl-8 text-sm font-semibold uppercase tracking-wider text-slate-600 hover:bg-slate-100 border-b border-slate-200">Mine oppskrifter</a>
<a id="mobile-menu-edit-recipes" href="#" class="hidden block px-4 py-3 pl-8 text-sm font-semibold uppercase tracking-wider text-slate-600 hover:bg-slate-100 border-b border-slate-200">Rediger oppskrifter</a>
<a id="mobile-menu-my-account" href="min-konto.html" class="block px-4 py-3 pl-8 text-sm font-semibold uppercase tracking-wider text-slate-600 hover:bg-slate-100 border-b border-slate-200">Min konto</a>
<button id="mobile-menu-logout" class="w-full text-left px-4 py-3 pl-8 text-sm font-semibold uppercase tracking-wider text-red-600 hover:bg-red-50 border-b border-slate-200">Logg ut</button>
</div>
</div>
</nav>
</div>
</div>
</header>
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
<!-- Banner Image -->
<div id="author-banner" class="w-full h-48 bg-gradient-to-r from-slate-200 to-slate-100 dark:from-slate-800 dark:to-slate-700 bg-cover bg-center rounded-xl mb-8" style="display:none"></div>
<!-- Breadcrumbs -->
<nav class="flex items-center gap-2 text-sm text-slate-500 mb-6" style="display:none">
<a class="hover:text-primary" href="#">Hjem</a>
<span class="material-symbols-outlined text-xs">chevron_right</span>
<a class="hover:text-primary" href="#">Oppskrifter</a>
<span class="material-symbols-outlined text-xs">chevron_right</span>
<span class="text-slate-900 font-medium">Ny oppskrift</span>
</nav>
<!-- Page Header -->
<div class="mb-10">
<h2 id="page-title-heading" class="text-4xl font-black text-slate-900 mb-3">Legg til ny oppskrift</h2>
<p class="text-slate-600 max-w-2xl">Del din matglede med Sørlandsidyll-fellesskapet. Fyll ut detaljene nedenfor for å legge til din unike sørlandssmak.</p>
</div>
<form class="space-y-12">
<!-- Basic Info Section -->
<section class="bg-white dark:bg-slate-900 p-6 md:p-8 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800">
<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
<div class="space-y-6">
<div>
<label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Oppskriftens tittel</label>
<input id="recipe-title" class="w-full px-4 py-3 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 focus:border-primary focus:ring-1 focus:ring-primary transition-all" placeholder="f.eks. Verdens beste fiskesuppe" type="text"/>
</div>
<div>
<label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Kategori</label>
<select id="category" class="w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 focus:border-primary focus:ring-1 focus:ring-primary transition-all">
<option value="">Velg en kategori</option>
</select>
</div>
<div>
<label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Kort beskrivelse</label>
<textarea id="recipe-description" class="w-full px-4 py-3 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 focus:border-primary focus:ring-1 focus:ring-primary transition-all" placeholder="Fortell litt om historien bak eller hvorfor du elsker denne retten..." rows="4"></textarea>
</div>
<div class="w-40">
<label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Porsjoner</label>
<div class="flex items-center gap-2">
<button type="button" id="decrease-portions" class="w-10 h-10 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center transition-colors">
<span class="material-symbols-outlined text-slate-600 dark:text-slate-300">remove</span>
</button>
<div class="relative flex-1">
<input id="portions-input" class="w-full px-4 py-3 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 focus:border-primary focus:ring-1 focus:ring-primary transition-all text-center" min="1" type="number" value="4"/>
</div>
<button type="button" id="increase-portions" class="w-10 h-10 rounded-lg bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 flex items-center justify-center transition-colors">
<span class="material-symbols-outlined text-slate-600 dark:text-slate-300">add</span>
</button>
</div>
</div>
</div>
<!-- Image Upload -->
<div>
<label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">Hovedbilde</label>
<div id="recipe-image-container" class="relative group cursor-pointer h-full min-h-[250px] border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl bg-slate-50 dark:bg-slate-800 flex flex-col items-center justify-center transition-colors hover:border-primary/50 bg-cover bg-center">
<div id="recipe-image-placeholder" class="flex flex-col items-center text-center p-6">
<span class="material-symbols-outlined text-5xl text-slate-300 group-hover:text-primary mb-4 transition-colors">add_a_photo</span>
<p class="text-sm font-medium text-slate-600 dark:text-slate-400">Dra og slipp eller klikk for å laste opp</p>
<p class="text-xs text-slate-400 mt-2">Anbefalt størrelse: 1200x800px (JPG, PNG)</p>
</div>
<button id="recipe-image-delete" type="button" class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity hidden">
<span class="material-symbols-outlined">delete</span>
</button>
</div>
</div>
</div>
</section>
<!-- Ingredients Section -->
<section class="bg-white dark:bg-slate-900 p-6 md:p-8 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800">
<div class="flex items-center justify-between mb-6">
<h3 class="text-xl font-bold flex items-center gap-2">
<span class="material-symbols-outlined text-primary">restaurant_menu</span>
                        Ingredienser
                    </h3>
<button id="add-section-btn" class="text-primary text-sm font-semibold flex items-center gap-1 hover:underline" type="button">
<span class="material-symbols-outlined text-base">add</span>
                        Legg til seksjon
                    </button>
</div>
<div id="ingredients-container" class="space-y-3 mb-6">
<!-- Ingredient Row -->
<div class="flex gap-3 ingredient-row" draggable="true">
<button class="p-3 text-slate-400 hover:text-slate-600 cursor-move drag-handle" type="button">
<span class="material-symbols-outlined">drag_indicator</span>
</button>
<input class="w-20 px-4 py-3 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 focus:ring-1 focus:ring-primary" placeholder="2" type="text"/>
<select class="w-24 px-3 py-3 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 focus:ring-1 focus:ring-primary">
<option value="g">g</option>
<option value="dl">dl</option>
<option value="ss" selected>ss</option>
<option value="ts">ts</option>
<option value="stk">stk</option>
<option value="fedd">fedd</option>
<option value="">-</option>
</select>
<input class="flex-1 px-4 py-3 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 focus:ring-1 focus:ring-primary" placeholder="Smør" type="text"/>
<button class="p-3 text-slate-300 hover:text-red-500 transition-colors delete-ingredient" type="button">
<span class="material-symbols-outlined">delete</span>
</button>
</div>
<!-- Ingredient Row -->
<div class="flex gap-3 ingredient-row" draggable="true">
<button class="p-3 text-slate-400 hover:text-slate-600 cursor-move drag-handle" type="button">
<span class="material-symbols-outlined">drag_indicator</span>
</button>
<input class="w-20 px-4 py-3 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 focus:ring-1 focus:ring-primary" placeholder="250" type="text"/>
<select class="w-24 px-3 py-3 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 focus:ring-1 focus:ring-primary">
<option value="g" selected>g</option>
<option value="dl">dl</option>
<option value="ss">ss</option>
<option value="ts">ts</option>
<option value="stk">stk</option>
<option value="fedd">fedd</option>
<option value="">-</option>
</select>
<input class="flex-1 px-4 py-3 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 focus:ring-1 focus:ring-primary" placeholder="Mel" type="text"/>
<button class="p-3 text-slate-300 hover:text-red-500 transition-colors delete-ingredient" type="button">
<span class="material-symbols-outlined">delete</span>
</button>
</div>
</div>
<button id="add-ingredient-btn" class="w-full py-3 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-lg text-slate-500 hover:border-primary hover:text-primary font-medium flex items-center justify-center gap-2 transition-all" type="button">
<span class="material-symbols-outlined">add</span>
                    Legg til ingrediens
                </button>

<!-- Delete Section Confirmation Popup -->
<div id="delete-section-popup" class="hidden fixed inset-0 z-50 flex items-center justify-center" style="background: rgba(0,0,0,0.4);">
    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-2xl p-6 max-w-md mx-4 border border-slate-200 dark:border-slate-700 animate-scale-in">
        <div class="flex items-start gap-4 mb-4">
            <div class="p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">
                <span class="material-symbols-outlined text-red-500 text-2xl">warning</span>
            </div>
            <div>
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Slette seksjon?</h3>
                <p class="text-sm text-slate-600 dark:text-slate-400">Alle ingredienser i denne seksjonen vil bli permanent slettet. Denne handlingen kan ikke angres.</p>
            </div>
        </div>
        <div class="flex gap-3 justify-end">
            <button id="cancel-delete-section" class="px-4 py-2 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 font-medium transition-colors" type="button">
                Avbryt
            </button>
            <button id="confirm-delete-section" class="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-medium transition-colors" type="button">
                Slett seksjon
            </button>
        </div>
    </div>
</div>

</section>
<!-- Instructions Section -->
<section class="bg-white dark:bg-slate-900 p-6 md:p-8 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800">
<div class="flex items-center justify-between mb-6">
<h3 class="text-xl font-bold flex items-center gap-2">
<span class="material-symbols-outlined text-primary">format_list_numbered</span>
                        Fremgangsmåte
                    </h3>
<button id="add-instruction-section-btn" class="text-primary text-sm font-semibold flex items-center gap-1 hover:underline" type="button">
<span class="material-symbols-outlined text-base">add</span>
                        Legg til seksjon
                    </button>
</div>
<div id="steps-container" class="space-y-6 mb-8">
<!-- Step Item -->
<div class="flex gap-4 group step-item">
<div class="flex-shrink-0 size-8 rounded-full bg-primary/10 text-primary font-bold flex items-center justify-center text-sm step-number">1</div>
<div class="flex-1">
<textarea class="w-full px-4 py-3 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 focus:ring-1 focus:ring-primary" placeholder="Beskriv det første steget her..." rows="2"></textarea>
</div>
<button class="mt-2 text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100 delete-step" type="button">
<span class="material-symbols-outlined">delete</span>
</button>
</div>
<!-- Step Item -->
<div class="flex gap-4 group step-item">
<div class="flex-shrink-0 size-8 rounded-full bg-primary/10 text-primary font-bold flex items-center justify-center text-sm step-number">2</div>
<div class="flex-1">
<textarea class="w-full px-4 py-3 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 focus:ring-1 focus:ring-primary" placeholder="Hva skjer videre?" rows="2"></textarea>
</div>
<button class="mt-2 text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100 delete-step" type="button">
<span class="material-symbols-outlined">delete</span>
</button>
</div>
</div>
<button id="add-step-btn" class="w-full py-3 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-lg text-slate-500 hover:border-primary hover:text-primary font-medium flex items-center justify-center gap-2 transition-all" type="button">
<span class="material-symbols-outlined">add</span>
                    Legg til steg
                </button>

<!-- Global Tips Section -->
<div class="mt-8 pt-8 border-t border-slate-200 dark:border-slate-700">
    <h4 class="text-lg font-semibold mb-4 flex items-center gap-2">
        <span class="material-symbols-outlined text-amber-500">lightbulb</span>
        Generelle tips
    </h4>
    <div id="global-tips-container" class="space-y-3 mb-4">
        <!-- Global tips will be added here -->
    </div>
    <button id="add-global-tip-btn" class="w-full py-3 border-2 border-dashed border-amber-200 dark:border-amber-800 rounded-lg text-amber-600 hover:border-amber-500 hover:text-amber-700 font-medium flex items-center justify-center gap-2 transition-all" type="button">
        <span class="material-symbols-outlined">lightbulb</span>
        Legg til generelt tips
    </button>
</div>

<!-- Delete Instruction Section Confirmation Popup -->
<div id="delete-instruction-section-popup" class="hidden fixed inset-0 z-50 flex items-center justify-center" style="background: rgba(0,0,0,0.4);">
    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-2xl p-6 max-w-md mx-4 border border-slate-200 dark:border-slate-700 animate-scale-in">
        <div class="flex items-start gap-4 mb-4">
            <div class="p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">
                <span class="material-symbols-outlined text-red-500 text-2xl">warning</span>
            </div>
            <div>
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">Slette seksjon?</h3>
                <p class="text-sm text-slate-600 dark:text-slate-400">Alle instruksjonssteg i denne seksjonen vil bli permanent slettet. Denne handlingen kan ikke angres.</p>
            </div>
        </div>
        <div class="flex gap-3 justify-end">
            <button id="cancel-delete-instruction-section" class="px-6 py-2 rounded-lg border border-slate-300 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" type="button">
                Avbryt
            </button>
            <button id="confirm-delete-instruction-section" class="px-6 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-semibold transition-colors" type="button">
                Slett seksjon
            </button>
        </div>
    </div>
</div>
</section>
<!-- Action Buttons -->
<div class="flex flex-col sm:flex-row items-center justify-end gap-4 pb-12">
<button class="w-full sm:w-auto px-8 py-3 rounded-full font-semibold text-slate-600 hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors border border-transparent" type="button">
                    Lagre utkast
                </button>
<button class="w-full sm:w-auto px-10 py-3 rounded-full bg-primary text-white font-bold shadow-lg shadow-primary/20 hover:bg-primary/90 transition-all flex items-center justify-center gap-2" type="submit">
<span class="material-symbols-outlined">check_circle</span>
                    Publiser oppskrift
                </button>
</div>
</form>

<!-- Recipe Image Upload Dialog -->
<dialog id="recipe-image-dialog" class="rounded-xl p-0 w-full max-w-lg border border-slate-200 shadow-2xl overflow-y-auto">
    <form id="recipe-image-form" method="dialog" class="p-4 sm:p-6 space-y-5">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-bold text-slate-900">Last opp hovedbilde</h3>
            <button id="recipe-image-close" type="button" class="text-slate-400 hover:text-slate-600">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <p class="text-sm text-slate-500">Velg kun ett av feltene under. Anbefalt størrelse: 1200x800px</p>
        <div class="space-y-4">
            <label class="recipe-image-field block text-sm font-semibold text-slate-700 transition-opacity">
                Råbilde
                <input id="recipe-raw-url" type="url" inputmode="url" placeholder="https://..." class="mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:ring-2 focus:ring-accent focus:border-transparent outline-none"/>
            </label>
            <label class="recipe-image-field block text-sm font-semibold text-slate-700 transition-opacity">
                GDrive delingslenke
                <input id="recipe-gdrive-url" type="url" inputmode="url" placeholder="https://drive.google.com/..." class="mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:ring-2 focus:ring-accent focus:border-transparent outline-none"/>
            </label>
            <label class="recipe-image-field block text-sm font-semibold text-slate-700 transition-opacity">
                OneDrive delingslenke
                <input id="recipe-onedrive-url" type="url" inputmode="url" placeholder="https://onedrive.live.com/..." class="mt-2 w-full rounded-lg border border-slate-200 px-3 py-2 text-sm focus:ring-2 focus:ring-accent focus:border-transparent outline-none"/>
            </label>
        </div>
        <p id="recipe-image-error" class="text-sm text-red-600 hidden"></p>
        <div class="flex flex-col sm:flex-row gap-3 sm:justify-end">
            <button type="button" id="recipe-image-cancel" class="px-4 py-2 rounded-lg border border-slate-200 text-slate-600 text-sm font-semibold hover:bg-slate-50">Avbryt</button>
            <button type="submit" class="px-4 py-2 rounded-lg bg-accent text-white text-sm font-semibold hover:bg-teal-700">Lagre</button>
        </div>
    </form>
</dialog>

</main>
<div id="footer-placeholder"></div>

<script type="module">
import { auth, db } from './assets/firebase.js';
import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js';
import { doc, getDoc, collection, getDocs, addDoc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js';

// Recipe image URL conversion functions
function extractGoogleDriveId(url) {
    const idMatch = url.match(/[?&]id=([^&]+)/);
    if (idMatch) return idMatch[1];
    const pathMatch = url.match(/\/d\/([^/]+)/);
    if (pathMatch) return pathMatch[1];
    return null;
}

function convertGoogleDriveUrl(url) {
    const id = extractGoogleDriveId(url);
    if (!id) return null;
    return `https://lh3.googleusercontent.com/d/${id}`;
}

// Load categories from Firebase
async function loadCategories() {
    try {
        const categorySelect = document.getElementById('category');
        if (!categorySelect) {
            return;
        }
        
        const categoriesRef = collection(db, 'cathegories');
        const categoriesSnapshot = await getDocs(categoriesRef);
        
        categoriesSnapshot.forEach((doc) => {
            const categoryData = doc.data();
            const option = document.createElement('option');
            option.value = doc.id;
            option.textContent = categoryData.name || doc.id;
            categorySelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

// Load categories on page load immediately
loadCategories();

// Edit recipe state
let isEditMode = false;
let editingRecipeId = null;

// Check for recipe ID in URL to load for editing
const urlParams = new URLSearchParams(window.location.search);
const recipeIdFromUrl = urlParams.get('id');

// Load recipe for editing if ID provided
async function loadRecipeForEditing(recipeId) {
    try {
        const recipeDoc = await getDoc(doc(db, 'recipes', recipeId));
        
        if (!recipeDoc.exists()) {
            console.error('Recipe not found');
            return;
        }
        
        const recipe = recipeDoc.data();
        console.log('Loaded recipe for editing:', recipe);
        
        isEditMode = true;
        editingRecipeId = recipeId;
        
        // Update page title and button
        const pageTitle = document.getElementById('page-title-heading');
        if (pageTitle) {
            pageTitle.textContent = 'Rediger oppskrift';
        }
        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.textContent = 'Oppdater oppskrift';
        }
        
        // Populate form fields
        document.getElementById('recipe-title').value = recipe.title || '';
        document.getElementById('recipe-description').value = recipe.description || '';
        document.getElementById('category').value = recipe.category || '';
        document.getElementById('portions-input').value = recipe.base_portions || 4;
        
        // Load recipe image if exists
        if (recipe.img_url) {
            currentRecipeImageUrl = recipe.img_url;
            const recipeImageContainer = document.getElementById('recipe-image-container');
            const recipeImagePlaceholder = document.getElementById('recipe-image-placeholder');
            if (recipeImageContainer && recipeImagePlaceholder) {
                const img = document.createElement('img');
                img.src = recipe.img_url;
                img.alt = recipe.title || 'Recipe image';
                img.className = 'w-full h-full object-cover';
                recipeImageContainer.innerHTML = '';
                recipeImageContainer.appendChild(img);
                recipeImagePlaceholder.style.display = 'none';
            }
        }
        
        // Populate ingredients
        const ingredientsContainer = document.getElementById('ingredients-container');
        ingredientsContainer.innerHTML = ''; // Clear existing rows
        
        // Check if we have the new section-based structure
        if (recipe.ingredient_sections && recipe.ingredient_sections.length > 0) {
            // NEW FORMAT: Load sections with ingredients
            console.log('Loading recipe with ingredient sections (new format)');
            recipe.ingredient_sections.forEach((section) => {
                // Add section header if section has a title
                if (section.title) {
                    const sectionHeader = createSectionHeader(section.title);
                    ingredientsContainer.appendChild(sectionHeader);
                }
                
                // Add ingredients for this section
                if (section.ingredients && section.ingredients.length > 0) {
                    section.ingredients.forEach((ingredient) => {
                        const row = createIngredientRow(
                            ingredient.amount || '',
                            ingredient.unit || '',
                            ingredient.name || '',
                            ingredient.substitutions || [] // Pass substitutions if they exist
                        );
                        ingredientsContainer.appendChild(row);
                    });
                }
            });
        } else if (recipe.ingr_title && recipe.ingr_title.length > 0) {
            // OLD FORMAT: Load flat list of ingredients (backward compatibility)
            console.log('⚠️ Loading recipe with old flat ingredient format - will be upgraded to sections when saved');
            recipe.ingr_title.forEach((title, index) => {
                const amount = recipe.ingr_numb && recipe.ingr_numb[index] ? recipe.ingr_numb[index] : '';
                const unit = recipe.ingr_unit && recipe.ingr_unit[index] ? recipe.ingr_unit[index] : '';
                
                const row = createIngredientRow(amount, unit, title);
                ingredientsContainer.appendChild(row);
            });
        }
        
        // Populate instructions
        const stepsContainer = document.getElementById('steps-container');
        stepsContainer.innerHTML = ''; // Clear existing steps
        
        // Check if we have the new section-based structure
        if (recipe.instruction_sections && recipe.instruction_sections.length > 0) {
            // NEW FORMAT: Load sections with steps
            console.log('Loading recipe with instruction sections (new format)');
            recipe.instruction_sections.forEach((section) => {
                // Add section header if section has a title
                if (section.title) {
                    const sectionHeader = createInstructionSectionHeader(section.title);
                    stepsContainer.appendChild(sectionHeader);
                }
                
                // Add steps for this section
                if (section.steps && section.steps.length > 0) {
                    section.steps.forEach((stepData) => {
                        // Handle both old format (string) and new format (object with text and tips)
                        const stepText = typeof stepData === 'string' ? stepData : stepData.text;
                        const stepTips = typeof stepData === 'object' ? (stepData.tips || []) : [];
                        
                        const step = createStepRow(stepText, stepTips);
                        stepsContainer.appendChild(step);
                    });
                }
            });
            updateStepNumbers();
        } else if (recipe.instr && recipe.instr.length > 0) {
            // OLD FORMAT: Load flat list of instructions (backward compatibility)
            console.log('⚠️ Loading recipe with old flat instruction format - will be upgraded to sections when saved');
            recipe.instr.forEach((instruction) => {
                const step = createStepRow(instruction);
                stepsContainer.appendChild(step);
            });
            updateStepNumbers();
        }
        
        // Populate global tips
        const globalTipsContainer = document.getElementById('global-tips-container');
        if (globalTipsContainer && recipe.global_tips && recipe.global_tips.length > 0) {
            globalTipsContainer.innerHTML = ''; // Clear existing
            recipe.global_tips.forEach((tipText) => {
                const tipRow = createGlobalTipRow(tipText);
                globalTipsContainer.appendChild(tipRow);
            });
        }
        
    } catch (error) {
        console.error('Error loading recipe for editing:', error);
        alert('Feil ved lasting av oppskrift: ' + error.message);
    }
}

// Load recipe for editing if URL parameter exists
// NOTE: This is called from the bottom of the script after all functions are defined

onAuthStateChanged(auth, async (user) => {
    if (user) {
        try {
            const userAccessRef = doc(db, 'user_access', user.uid);
            const userAccessDoc = await getDoc(userAccessRef);
            if (userAccessDoc.exists()) {
                currentAuthor = userAccessDoc.data()['author-name'];
            }
        } catch (error) {
            console.error('Error loading author:', error);
        }
    }
});

// Form submission handler
document.querySelector('form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!currentAuthor) {
        alert('Feil: Kunne ikke finne forfatter. Vennligst logg inn på nytt.');
        return;
    }
    
    try {
        // Collect form data
        const title = document.getElementById('recipe-title').value.trim();
        const description = document.getElementById('recipe-description').value.trim();
        const category = document.getElementById('category').value;
        const portions = parseInt(document.getElementById('portions-input').value) || 1;
        const imgUrl = currentRecipeImageUrl;
        
        if (!title) {
            alert('Vennligst fyll inn oppskriftens tittel');
            return;
        }
        
        // Collect ingredients grouped by sections
        // NOTE: This automatically upgrades old recipes (flat arrays) to new format (sectioned arrays)
        // when editing and saving. Old recipes without sections will be converted seamlessly.
        const container = document.getElementById('ingredients-container');
        const children = Array.from(container.children);
        
        const ingredientSections = [];
        const ingrNumb = [];  // Flat arrays for backward compatibility
        const ingrTitle = [];
        const ingrUnit = [];
        
        let currentSection = {
            title: "",  // Empty title for default section
            ingredients: []
        };
        
        children.forEach((element) => {
            if (element.classList.contains('section-header')) {
                // Save previous section if it has ingredients
                if (currentSection.ingredients.length > 0) {
                    ingredientSections.push(currentSection);
                }
                
                // Start new section
                const sectionInput = element.querySelector('input[type="text"]');
                currentSection = {
                    title: sectionInput ? sectionInput.value.trim() : "",
                    ingredients: []
                };
            } else if (element.classList.contains('ingredient-row-wrapper')) {
                const mainRow = element.querySelector('.ingredient-row');
                if (!mainRow) return; // Skip if ingredient-row not found
                const amountInput = mainRow.querySelector('.ingredient-amount');
                const unitSelect = mainRow.querySelector('.ingredient-unit');
                const nameInput = mainRow.querySelector('.ingredient-name');
                
                if (amountInput && nameInput) {
                    const amount = amountInput.value.trim();
                    const name = nameInput.value.trim();
                    const unit = unitSelect ? unitSelect.value : '';
                    
                    if (name) { // Only add if name exists
                        const ingredient = {
                            amount: amount ? parseFloat(amount) : '',
                            unit: unit,
                            name: name
                        };
                        
                        // Collect substitutions for this ingredient
                        const subsContainer = element.querySelector('.substitutions-container');
                        if (subsContainer) {
                            const subRows = subsContainer.querySelectorAll('.substitution-row');
                            if (subRows.length > 0) {
                                ingredient.substitutions = [];
                                subRows.forEach(subRow => {
                                    const subAmount = subRow.querySelector('.sub-amount').value.trim();
                                    const subUnit = subRow.querySelector('.sub-unit').value;
                                    const subName = subRow.querySelector('.sub-name').value.trim();
                                    
                                    if (subName) {
                                        ingredient.substitutions.push({
                                            amount: subAmount ? parseFloat(subAmount) : '',
                                            unit: subUnit,
                                            name: subName
                                        });
                                    }
                                });
                            }
                        }
                        
                        currentSection.ingredients.push(ingredient);
                        
                        // Also add to flat arrays for backward compatibility
                        ingrNumb.push(ingredient.amount);
                        ingrTitle.push(ingredient.name);
                        ingrUnit.push(ingredient.unit);
                    }
                }
            }
        });
        
        // Don't forget to add the last section
        if (currentSection.ingredients.length > 0) {
            ingredientSections.push(currentSection);
        }
        
        if (ingrTitle.length === 0) {
            alert('Vennligst legg til minst én ingrediens');
            return;
        }
        
        console.log('Ingredients (sections):', ingredientSections);
        console.log('Ingredients (flat):', { 
            count: ingrTitle.length, 
            numbers: ingrNumb, 
            titles: ingrTitle, 
            units: ingrUnit 
        });
        
        // Collect steps grouped by sections
        // NOTE: This automatically upgrades old recipes (flat arrays) to new format (sectioned arrays)
        const stepsContainer = document.getElementById('steps-container');
        const stepChildren = Array.from(stepsContainer.children);
        
        const instructionSections = [];
        const instr = [];  // Flat array for backward compatibility
        
        let currentInstructionSection = {
            title: "",  // Empty title for default section
            steps: []
        };
        
        stepChildren.forEach((element) => {
            if (element.classList.contains('instruction-section-header')) {
                // Save previous section if it has steps
                if (currentInstructionSection.steps.length > 0) {
                    instructionSections.push(currentInstructionSection);
                }
                
                // Start new section
                const sectionInput = element.querySelector('input[type="text"]');
                currentInstructionSection = {
                    title: sectionInput ? sectionInput.value.trim() : "",
                    steps: []
                };
            } else if (element.classList.contains('step-item-wrapper')) {
                const stepItem = element.querySelector('.step-item');
                if (!stepItem) return; // Skip if step-item not found
                const textarea = stepItem.querySelector('.step-text');
                if (textarea) {
                    const text = textarea.value.trim();
                    if (text) {
                        const stepData = { text: text };
                        
                        // Collect tips for this step
                        const tipsContainer = element.querySelector('.step-tips-container');
                        if (tipsContainer) {
                            const tipRows = tipsContainer.querySelectorAll('.step-tip-row');
                            if (tipRows.length > 0) {
                                stepData.tips = [];
                                tipRows.forEach(tipRow => {
                                    const tipText = tipRow.querySelector('.step-tip-text').value.trim();
                                    if (tipText) {
                                        stepData.tips.push(tipText);
                                    }
                                });
                            }
                        }
                        
                        currentInstructionSection.steps.push(stepData);
                        
                        // Also add to flat array for backward compatibility (text only)
                        instr.push(text);
                    }
                }
            } else if (element.classList.contains('step-item')) {
                // Handle old step items without wrapper (for backward compatibility during load)
                const textarea = element.querySelector('textarea');
                if (textarea) {
                    const text = textarea.value.trim();
                    if (text) {
                        currentInstructionSection.steps.push({ text: text });
                        
                        // Also add to flat array for backward compatibility
                        instr.push(text);
                    }
                }
            }
        });
        
        // Don't forget to add the last section
        if (currentInstructionSection.steps.length > 0) {
            instructionSections.push(currentInstructionSection);
        }
        
        if (instr.length === 0) {
            alert('Vennligst legg til minst ett instruksjonssteg');
            return;
        }
        
        console.log('Instructions (sections):', instructionSections);
        console.log('Instructions (flat):', { count: instr.length, steps: instr });
        
        // Collect global tips
        const globalTips = [];
        const globalTipsContainer = document.getElementById('global-tips-container');
        if (globalTipsContainer) {
            const tipRows = globalTipsContainer.querySelectorAll('.global-tip-row');
            tipRows.forEach(tipRow => {
                const tipText = tipRow.querySelector('.global-tip-text').value.trim();
                if (tipText) {
                    globalTips.push(tipText);
                }
            });
        }
        
        console.log('Global tips:', globalTips);
        
        // Create category boolean flags AND array
        const categoryFlags = {};
        const categoriesArray = [];
        const allCategories = ['bakst', 'dessert', 'middag', 'tilbehør'];
        
        allCategories.forEach((cat) => {
            const isSelected = (category === cat);
            categoryFlags['t' + cat] = isSelected;
            if (isSelected) {
                categoriesArray.push(cat);
            }
        });
        
        console.log('Categories:', { selected: category, flags: categoryFlags, array: categoriesArray });
        
        // Determine if this is an upgrade from old format to new format
        const isUpgradingToSections = isEditMode && (ingredientSections.length > 0 || instructionSections.length > 0);
        
        // Create recipe document
        const recipeData = {
            author: currentAuthor,
            base_portions: portions,
            created_date: serverTimestamp(),
            description: description,
            img_url: imgUrl,
            ingredient_sections: ingredientSections, // NEW: Structured sections with ingredients (with substitutions)
            instruction_sections: instructionSections, // NEW: Structured sections with instructions (with tips)
            global_tips: globalTips, // NEW: Array of global tips for the recipe
            ingr_numb: ingrNumb, // Array (kept for backward compatibility)
            ingr_title: ingrTitle, // Array (kept for backward compatibility)
            ingr_unit: ingrUnit, // Array (kept for backward compatibility)
            instr: instr, // Array (kept for backward compatibility)
            title: title,
            category: category,
            categories: categoriesArray, // Array of selected categories
            ...categoryFlags // Boolean flags (tbakst, tdessert, etc.)
        };
        
        console.log('Final recipe data:', recipeData);
        
        if (isUpgradingToSections) {
            console.log('✅ Upgrading recipe to new sections format');
        }
        
        // Add or update recipe in Firebase
        if (isEditMode && editingRecipeId) {
            // Update existing recipe
            await updateDoc(doc(db, 'recipes', editingRecipeId), recipeData);
            
            // Check if we upgraded the format
            const upgradeMessage = (ingredientSections.length > 0 || instructionSections.length > 0)
                ? ' Oppskriften har blitt oppgradert til det nye formatet med seksjoner.' 
                : '';
            
            alert('Oppskriften ble oppdatert!' + upgradeMessage);
        } else {
            // Create new recipe
            const recipesRef = collection(db, 'recipes');
            const docRef = await addDoc(recipesRef, recipeData);
            alert('Oppskriften ble publisert!');
        }
        
        // Reset form and redirect
        document.querySelector('form').reset();
        currentRecipeImageUrl = '';
        
        // Redirect to recipe detail page if editing, or stay on form if new
        if (isEditMode && editingRecipeId) {
            window.location.href = `oppskrift.html?id=${editingRecipeId}`;
        }
        
    } catch (error) {
        console.error('Error publishing recipe:', error);
        alert('Feil ved publisering av oppskrift: ' + error.message);
    }
});

// Recipe image dialog setup
const recipeImageDialog = document.getElementById('recipe-image-dialog');
const recipeImageForm = document.getElementById('recipe-image-form');
const recipeImageContainer = document.getElementById('recipe-image-container');
const recipeImagePlaceholder = document.getElementById('recipe-image-placeholder');
const recipeImageDelete = document.getElementById('recipe-image-delete');
const recipeRawInput = document.getElementById('recipe-raw-url');
const recipeGdriveInput = document.getElementById('recipe-gdrive-url');
const recipeOnedriveInput = document.getElementById('recipe-onedrive-url');
const recipeImageClose = document.getElementById('recipe-image-close');
const recipeImageCancel = document.getElementById('recipe-image-cancel');
let currentRecipeImageUrl = '';
let currentAuthor = '';

function openRecipeImageDialog() {
    if (!recipeImageDialog) return;
    recipeImageDialog.showModal();
    recipeRawInput.value = '';
    recipeGdriveInput.value = '';
    recipeOnedriveInput.value = '';
}

function closeRecipeImageDialog() {
    if (!recipeImageDialog) return;
    recipeImageDialog.close();
}

function deleteRecipeImage() {
    currentRecipeImageUrl = '';
    recipeImageContainer.style.backgroundImage = '';
    if (recipeImagePlaceholder) {
        recipeImagePlaceholder.style.display = 'flex';
    }
    if (recipeImageDelete) {
        recipeImageDelete.classList.add('hidden');
    }
}

if (recipeImageContainer) {
    recipeImageContainer.addEventListener('click', (e) => {
        if (e.target.closest('#recipe-image-delete')) {
            e.stopPropagation();
            deleteRecipeImage();
        } else {
            openRecipeImageDialog();
        }
    });
}

if (recipeImageDelete) {
    recipeImageDelete.addEventListener('click', (e) => {
        e.stopPropagation();
        deleteRecipeImage();
    });
}

if (recipeImageClose) {
    recipeImageClose.addEventListener('click', closeRecipeImageDialog);
}

if (recipeImageCancel) {
    recipeImageCancel.addEventListener('click', closeRecipeImageDialog);
}

if (recipeImageForm) {
    recipeImageForm.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const rawUrl = recipeRawInput.value.trim();
        const gdriveUrl = recipeGdriveInput.value.trim();
        const onedriveUrl = recipeOnedriveInput.value.trim();
        const filled = [rawUrl, gdriveUrl, onedriveUrl].filter(v => v).length;
        
        if (filled !== 1) {
            console.error('Please fill in exactly one field');
            return;
        }
        
        let finalUrl = '';
        if (rawUrl) {
            finalUrl = rawUrl;
        } else if (gdriveUrl) {
            finalUrl = convertGoogleDriveUrl(gdriveUrl);
        } else if (onedriveUrl) {
            finalUrl = onedriveUrl;
        }
        
        if (finalUrl) {
            currentRecipeImageUrl = finalUrl;
            recipeImageContainer.style.backgroundImage = `url('${finalUrl}')`;
            if (recipeImagePlaceholder) {
                recipeImagePlaceholder.style.display = 'none';
            }
            if (recipeImageDelete) {
                recipeImageDelete.classList.remove('hidden');
            }
            closeRecipeImageDialog();
        }
    });
}

// Load author banner
onAuthStateChanged(auth, async (user) => {
    console.log('Auth state changed, user:', user ? user.uid : 'none');
    if (user) {
        try {
            const userAccessRef = doc(db, 'user_access', user.uid);
            const userAccessDoc = await getDoc(userAccessRef);
            
            console.log('User access doc exists:', userAccessDoc.exists());
            
            if (userAccessDoc.exists()) {
                const userAccessData = userAccessDoc.data();
                const authorName = userAccessData['author-name'];
                
                console.log('Author name:', authorName);
                
                if (authorName) {
                    const authorRef = doc(db, 'authors', authorName);
                    const authorSnap = await getDoc(authorRef);
                    
                    console.log('Author doc exists:', authorSnap.exists());
                    
                    if (authorSnap.exists()) {
                        const authorData = authorSnap.data();
                        const authorBanner = document.getElementById('author-banner');
                        
                        console.log('Banner element found:', !!authorBanner);
                        console.log('img_banner value:', authorData['img_banner']);
                        
                        if (authorBanner && authorData['img_banner']) {
                            authorBanner.style.backgroundImage = `url('${authorData['img_banner']}')`;
                            authorBanner.style.display = 'block';
                            console.log('Banner displayed successfully');
                        } else {
                            console.log('No banner to display or element not found');
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Error loading author banner:', error);
        }
    }
});

// Portions controls
document.getElementById('increase-portions').addEventListener('click', () => {
    const input = document.getElementById('portions-input');
    const currentValue = parseInt(input.value) || 1;
    input.value = currentValue + 1;
});

document.getElementById('decrease-portions').addEventListener('click', () => {
    const input = document.getElementById('portions-input');
    const currentValue = parseInt(input.value) || 1;
    if (currentValue > 1) {
        input.value = currentValue - 1;
    }
});

// Ingredient management
function createIngredientRow(amount = '', unit = '', name = '', substitutions = []) {
    const row = document.createElement('div');
    row.className = 'ingredient-row-wrapper mb-3';
    
    const mainRow = document.createElement('div');
    mainRow.className = 'flex gap-3 ingredient-row';
    mainRow.draggable = true;
    mainRow.innerHTML = `
        <button class="p-3 text-slate-400 hover:text-slate-600 cursor-move drag-handle" type="button">
            <span class="material-symbols-outlined">drag_indicator</span>
        </button>
        <input class="w-20 px-4 py-3 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 focus:ring-1 focus:ring-primary ingredient-amount" placeholder="2" type="text" value="${amount}"/>
        <select class="w-24 px-3 py-3 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 focus:ring-1 focus:ring-primary ingredient-unit">
            <option value="g" ${unit === 'g' ? 'selected' : ''}>g</option>
            <option value="kg" ${unit === 'kg' ? 'selected' : ''}>kg</option>
            <option value="dl" ${unit === 'dl' ? 'selected' : ''}>dl</option>
            <option value="ss" ${unit === 'ss' ? 'selected' : ''}>ss</option>
            <option value="ts" ${unit === 'ts' ? 'selected' : ''}>ts</option>
            <option value="stk" ${unit === 'stk' ? 'selected' : ''}>stk</option>
            <option value="pk" ${unit === 'pk' ? 'selected' : ''}>pk</option>
            <option value="fedd" ${unit === 'fedd' ? 'selected' : ''}>fedd</option>
            <option value="" ${unit === '' ? 'selected' : ''}>-</option>
        </select>
        <input class="flex-1 px-4 py-3 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 focus:ring-1 focus:ring-primary ingredient-name" placeholder="Ingrediens" type="text" value="${name}"/>
        <button class="p-3 text-slate-400 hover:text-primary transition-colors add-substitution" type="button" title="Legg til erstatning">
            <span class="material-symbols-outlined">add_circle</span>
        </button>
        <button class="p-3 text-slate-300 hover:text-red-500 transition-colors delete-ingredient" type="button">
            <span class="material-symbols-outlined">delete</span>
        </button>
    `;
    
    row.appendChild(mainRow);
    
    // Create substitutions container
    const subsContainer = document.createElement('div');
    subsContainer.className = 'substitutions-container ml-16 mt-2 space-y-2 hidden';
    row.appendChild(subsContainer);
    
    // Add existing substitutions if any
    if (substitutions && substitutions.length > 0) {
        subsContainer.classList.remove('hidden');
        substitutions.forEach(sub => {
            const subRow = createSubstitutionRow(sub.amount, sub.unit, sub.name);
            subsContainer.appendChild(subRow);
        });
    }
    
    return row;
}

function createSubstitutionRow(amount = '', unit = '', name = '') {
    const subRow = document.createElement('div');
    subRow.className = 'flex gap-3 substitution-row bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg';
    subRow.innerHTML = `
        <span class="p-3 text-slate-400 text-xs">Alt:</span>
        <input class="w-20 px-3 py-2 text-sm rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 focus:ring-1 focus:ring-primary sub-amount" placeholder="2" type="text" value="${amount}"/>
        <select class="w-24 px-2 py-2 text-sm rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 focus:ring-1 focus:ring-primary sub-unit">
            <option value="g" ${unit === 'g' ? 'selected' : ''}>g</option>
            <option value="dl" ${unit === 'dl' ? 'selected' : ''}>dl</option>
            <option value="ss" ${unit === 'ss' ? 'selected' : ''}>ss</option>
            <option value="ts" ${unit === 'ts' ? 'selected' : ''}>ts</option>
            <option value="stk" ${unit === 'stk' ? 'selected' : ''}>stk</option>
            <option value="fedd" ${unit === 'fedd' ? 'selected' : ''}>fedd</option>
            <option value="" ${unit === '' ? 'selected' : ''}>-</option>
        </select>
        <input class="flex-1 px-3 py-2 text-sm rounded-lg border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 focus:ring-1 focus:ring-primary sub-name" placeholder="Alternativ ingrediens" type="text" value="${name}"/>
        <button class="p-2 text-slate-300 hover:text-red-500 transition-colors delete-substitution" type="button">
            <span class="material-symbols-outlined text-sm">close</span>
        </button>
    `;
    return subRow;
}

function createSectionHeader(title = '') {
    const section = document.createElement('div');
    section.className = 'section-header mt-6 pt-6 border-t border-slate-200 dark:border-slate-700';
    section.innerHTML = `
        <div class="flex items-center gap-3 mb-4">
            <button class="p-2 text-slate-300 hover:text-red-500 transition-colors delete-section" type="button">
                <span class="material-symbols-outlined">delete</span>
            </button>
            <input class="flex-1 text-lg font-semibold bg-transparent border-b-2 border-slate-300 dark:border-slate-600 focus:border-primary outline-none px-2 py-1" type="text" placeholder="Seksjonstittel (f.eks. Deig)" value="${title}"/>
        </div>
    `;
    return section;
}

function createInstructionSectionHeader(title = '') {
    const section = document.createElement('div');
    section.className = 'instruction-section-header mt-6 pt-6 border-t border-slate-200 dark:border-slate-700';
    section.innerHTML = `
        <div class="flex items-center gap-3 mb-4">
            <button class="p-2 text-slate-300 hover:text-red-500 transition-colors delete-instruction-section" type="button">
                <span class="material-symbols-outlined">delete</span>
            </button>
            <input class="flex-1 text-lg font-semibold bg-transparent border-b-2 border-slate-300 dark:border-slate-600 focus:border-primary outline-none px-2 py-1" type="text" placeholder="Seksjonstittel (f.eks. Forberedelse)" value="${title}"/>
        </div>
    `;
    return section;
}

// Add ingredient button
document.getElementById('add-ingredient-btn').addEventListener('click', () => {
    const container = document.getElementById('ingredients-container');
    const newRow = createIngredientRow();
    container.appendChild(newRow);
});

// Add section button
document.getElementById('add-section-btn').addEventListener('click', () => {
    const container = document.getElementById('ingredients-container');
    const sectionHeader = createSectionHeader();
    const newRow = createIngredientRow();
    
    // Check if this is the first section
    const existingSections = container.querySelectorAll('.section-header');
    
    if (existingSections.length === 0) {
        // First section: add at the top (before all ingredients)
        const firstChild = container.firstChild;
        if (firstChild) {
            container.insertBefore(newRow, firstChild);
            container.insertBefore(sectionHeader, newRow);
            // Autoscroll to the new section
            sectionHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            container.appendChild(sectionHeader);
            container.appendChild(newRow);
            // Autoscroll to the new section
            sectionHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    } else {
        // Subsequent sections: add at the bottom (after all ingredients)
        container.appendChild(sectionHeader);
        container.appendChild(newRow);
        // Autoscroll to the new section
        sectionHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
});

// Delete section confirmation popup
let sectionToDelete = null;
const deletePopup = document.getElementById('delete-section-popup');
const confirmDeleteBtn = document.getElementById('confirm-delete-section');
const cancelDeleteBtn = document.getElementById('cancel-delete-section');

// Show popup
function showDeleteSectionPopup(sectionHeader) {
    sectionToDelete = sectionHeader;
    deletePopup.classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // Prevent scrolling
}

// Hide popup
function hideDeleteSectionPopup() {
    deletePopup.classList.add('hidden');
    document.body.style.overflow = ''; // Restore scrolling
    sectionToDelete = null;
}

// Cancel button
cancelDeleteBtn.addEventListener('click', hideDeleteSectionPopup);

// Click outside popup to close
deletePopup.addEventListener('click', (e) => {
    if (e.target === deletePopup) {
        hideDeleteSectionPopup();
    }
});

// Confirm deletion
confirmDeleteBtn.addEventListener('click', () => {
    if (sectionToDelete) {
        // Remove section header and all ingredients until next section or end
        let nextElement = sectionToDelete.nextElementSibling;
        sectionToDelete.remove();
        
        while (nextElement && !nextElement.classList.contains('section-header')) {
            const toRemove = nextElement;
            nextElement = nextElement.nextElementSibling;
            toRemove.remove();
        }
    }
    hideDeleteSectionPopup();
});

// Delete ingredient/section handlers (event delegation)
document.getElementById('ingredients-container').addEventListener('click', (e) => {
    // Handle add substitution button
    const addSubBtn = e.target.closest('.add-substitution');
    if (addSubBtn) {
        const wrapper = addSubBtn.closest('.ingredient-row-wrapper');
        const subsContainer = wrapper.querySelector('.substitutions-container');
        subsContainer.classList.remove('hidden');
        const newSubRow = createSubstitutionRow();
        subsContainer.appendChild(newSubRow);
        return;
    }
    
    // Handle delete substitution button
    const deleteSubBtn = e.target.closest('.delete-substitution');
    if (deleteSubBtn) {
        const subRow = deleteSubBtn.closest('.substitution-row');
        const subsContainer = subRow.closest('.substitutions-container');
        subRow.remove();
        // Hide container if no more substitutions
        if (subsContainer.querySelectorAll('.substitution-row').length === 0) {
            subsContainer.classList.add('hidden');
        }
        return;
    }
    
    // Handle delete ingredient button
    const deleteBtn = e.target.closest('.delete-ingredient');
    if (deleteBtn) {
        const wrapper = deleteBtn.closest('.ingredient-row-wrapper');
        wrapper.remove();
        return;
    }
    
    const deleteSectionBtn = e.target.closest('.delete-section');
    if (deleteSectionBtn) {
        const sectionHeader = deleteSectionBtn.closest('.section-header');
        showDeleteSectionPopup(sectionHeader);
    }
});

// Add instruction section button
document.getElementById('add-instruction-section-btn').addEventListener('click', () => {
    const container = document.getElementById('steps-container');
    const sectionHeader = createInstructionSectionHeader();
    const newStep = createStepRow();
    
    // Check if this is the first section
    const existingSections = container.querySelectorAll('.instruction-section-header');
    
    if (existingSections.length === 0) {
        // First section: add at the top (before all steps)
        const firstChild = container.firstChild;
        if (firstChild) {
            container.insertBefore(newStep, firstChild);
            container.insertBefore(sectionHeader, newStep);
            // Autoscroll to the new section
            sectionHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            container.appendChild(sectionHeader);
            container.appendChild(newStep);
            // Autoscroll to the new section
            sectionHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    } else {
        // Subsequent sections: add at the bottom (after all steps)
        container.appendChild(sectionHeader);
        container.appendChild(newStep);
        // Autoscroll to the new section
        sectionHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    updateStepNumbers();
});

// Delete instruction section confirmation popup
let instructionSectionToDelete = null;
const deleteInstructionPopup = document.getElementById('delete-instruction-section-popup');
const confirmDeleteInstructionBtn = document.getElementById('confirm-delete-instruction-section');
const cancelDeleteInstructionBtn = document.getElementById('cancel-delete-instruction-section');

// Show instruction section delete popup
function showDeleteInstructionSectionPopup(sectionHeader) {
    instructionSectionToDelete = sectionHeader;
    deleteInstructionPopup.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

// Hide instruction section delete popup
function hideDeleteInstructionSectionPopup() {
    deleteInstructionPopup.classList.add('hidden');
    document.body.style.overflow = '';
    instructionSectionToDelete = null;
}

// Cancel button
cancelDeleteInstructionBtn.addEventListener('click', hideDeleteInstructionSectionPopup);

// Click outside popup to close
deleteInstructionPopup.addEventListener('click', (e) => {
    if (e.target === deleteInstructionPopup) {
        hideDeleteInstructionSectionPopup();
    }
});

// Confirm deletion
confirmDeleteInstructionBtn.addEventListener('click', () => {
    if (instructionSectionToDelete) {
        // Remove section header and all steps until next section or end
        let nextElement = instructionSectionToDelete.nextElementSibling;
        instructionSectionToDelete.remove();
        
        while (nextElement && !nextElement.classList.contains('instruction-section-header')) {
            const toRemove = nextElement;
            nextElement = nextElement.nextElementSibling;
            toRemove.remove();
        }
        updateStepNumbers();
    }
    hideDeleteInstructionSectionPopup();
});

// Delete instruction section handlers (event delegation)
document.getElementById('steps-container').addEventListener('click', (e) => {
    const deleteInstructionSectionBtn = e.target.closest('.delete-instruction-section');
    if (deleteInstructionSectionBtn) {
        const sectionHeader = deleteInstructionSectionBtn.closest('.instruction-section-header');
        showDeleteInstructionSectionPopup(sectionHeader);
    }
});

// Steps management
function createStepRow(text = '', tips = []) {
    const div = document.createElement('div');
    div.className = 'step-item-wrapper mb-6';
    
    const stepRow = document.createElement('div');
    stepRow.className = 'flex gap-4 group step-item';
    stepRow.innerHTML = `
        <div class="flex-shrink-0 size-8 rounded-full bg-primary/10 text-primary font-bold flex items-center justify-center text-sm step-number">1</div>
        <div class="flex-1">
            <textarea class="w-full px-4 py-3 rounded-lg border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 focus:ring-1 focus:ring-primary step-text" placeholder="Beskriv steget her..." rows="2">${text}</textarea>
        </div>
        <button class="mt-2 text-slate-400 hover:text-primary transition-colors add-step-tip" type="button" title="Legg til tips">
            <span class="material-symbols-outlined">lightbulb</span>
        </button>
        <button class="mt-2 text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100 delete-step" type="button">
            <span class="material-symbols-outlined">delete</span>
        </button>
    `;
    
    div.appendChild(stepRow);
    
    // Create tips container
    const tipsContainer = document.createElement('div');
    tipsContainer.className = 'step-tips-container ml-12 mt-2 space-y-2 hidden';
    div.appendChild(tipsContainer);
    
    // Add existing tips if any
    if (tips && tips.length > 0) {
        tipsContainer.classList.remove('hidden');
        tips.forEach(tip => {
            const tipRow = createStepTipRow(tip);
            tipsContainer.appendChild(tipRow);
        });
    }
    
    return div;
}

function createStepTipRow(text = '') {
    const tipRow = document.createElement('div');
    tipRow.className = 'flex gap-3 step-tip-row bg-amber-50 dark:bg-amber-900/10 p-3 rounded-lg border border-amber-200 dark:border-amber-800';
    tipRow.innerHTML = `
        <span class="material-symbols-outlined text-amber-500 text-sm mt-1">lightbulb</span>
        <textarea class="flex-1 text-sm bg-transparent border-none focus:outline-none resize-none step-tip-text" placeholder="Tips for dette steget..." rows="1">${text}</textarea>
        <button class="text-slate-300 hover:text-red-500 transition-colors delete-step-tip" type="button">
            <span class="material-symbols-outlined text-sm">close</span>
        </button>
    `;
    return tipRow;
}

function updateStepNumbers() {
    const stepsContainer = document.getElementById('steps-container');
    if (!stepsContainer) return;
    
    const steps = stepsContainer.querySelectorAll('.step-item');
    steps.forEach((step, index) => {
        const stepNumber = step.querySelector('.step-number');
        if (stepNumber) {
            stepNumber.textContent = index + 1;
        }
    });
}

// Add step button
const addStepBtn = document.getElementById('add-step-btn');
if (addStepBtn) {
    addStepBtn.addEventListener('click', () => {
        const stepsContainer = document.getElementById('steps-container');
        if (stepsContainer) {
            const newStep = createStepRow();
            stepsContainer.appendChild(newStep);
            updateStepNumbers();
        }
    });
}

// Delete step handlers and tip handlers (event delegation)
document.addEventListener('click', (e) => {
    // Handle add step tip button
    const addTipBtn = e.target.closest('.add-step-tip');
    if (addTipBtn) {
        const wrapper = addTipBtn.closest('.step-item-wrapper');
        const tipsContainer = wrapper.querySelector('.step-tips-container');
        tipsContainer.classList.remove('hidden');
        const newTipRow = createStepTipRow();
        tipsContainer.appendChild(newTipRow);
        return;
    }
    
    // Handle delete step tip button
    const deleteTipBtn = e.target.closest('.delete-step-tip');
    if (deleteTipBtn) {
        const tipRow = deleteTipBtn.closest('.step-tip-row');
        const tipsContainer = tipRow.closest('.step-tips-container');
        tipRow.remove();
        // Hide container if no more tips
        if (tipsContainer.querySelectorAll('.step-tip-row').length === 0) {
            tipsContainer.classList.add('hidden');
        }
        return;
    }
    
    // Handle delete step button
    const deleteStepBtn = e.target.closest('.delete-step');
    if (deleteStepBtn) {
        const wrapper = deleteStepBtn.closest('.step-item-wrapper');
        if (wrapper) {
            wrapper.remove();
            updateStepNumbers();
        }
    }
});

// Global tips management
function createGlobalTipRow(text = '') {
    const tipRow = document.createElement('div');
    tipRow.className = 'flex gap-3 global-tip-row bg-amber-50 dark:bg-amber-900/10 p-4 rounded-lg border border-amber-200 dark:border-amber-800';
    tipRow.innerHTML = `
        <span class="material-symbols-outlined text-amber-500 text-base mt-1">lightbulb</span>
        <textarea class="flex-1 bg-transparent border-none focus:outline-none resize-none global-tip-text" placeholder="Skriv et generelt tips for oppskriften..." rows="2">${text}</textarea>
        <button class="text-slate-300 hover:text-red-500 transition-colors delete-global-tip" type="button">
            <span class="material-symbols-outlined">close</span>
        </button>
    `;
    return tipRow;
}

// Add global tip button
const addGlobalTipBtn = document.getElementById('add-global-tip-btn');
if (addGlobalTipBtn) {
    addGlobalTipBtn.addEventListener('click', () => {
        const globalTipsContainer = document.getElementById('global-tips-container');
        if (globalTipsContainer) {
            const newTip = createGlobalTipRow();
            globalTipsContainer.appendChild(newTip);
        }
    });
}

// Delete global tip handler (event delegation)
document.addEventListener('click', (e) => {
    const deleteGlobalTipBtn = e.target.closest('.delete-global-tip');
    if (deleteGlobalTipBtn) {
        const tipRow = deleteGlobalTipBtn.closest('.global-tip-row');
        if (tipRow) {
            tipRow.remove();
        }
    }
});

// Drag and drop functionality
let draggedElement = null;

document.getElementById('ingredients-container').addEventListener('dragstart', (e) => {
    if (e.target.classList.contains('ingredient-row')) {
        draggedElement = e.target;
        e.target.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
    }
});

document.getElementById('ingredients-container').addEventListener('dragend', (e) => {
    if (e.target.classList.contains('ingredient-row')) {
        e.target.style.opacity = '1';
    }
});

document.getElementById('ingredients-container').addEventListener('dragover', (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    
    const container = document.getElementById('ingredients-container');
    const afterElement = getDragAfterElement(container, e.clientY);
    
    // Clear all border indicators
    container.querySelectorAll('.ingredient-row, .section-header').forEach(el => {
        el.style.borderTop = '';
        el.style.borderBottom = '';
    });
    
    if (afterElement == null) {
        // Add visual indicator at the end (allows moving out to end of list)
        const allChildren = Array.from(container.children);
        const lastChild = allChildren[allChildren.length - 1];
        if (lastChild && lastChild !== draggedElement) {
            lastChild.style.borderBottom = '2px solid #3b82f6';
        }
    } else {
        // Add indicator above the element we're hovering over (allows moving anywhere)
        afterElement.style.borderTop = '2px solid #3b82f6';
    }
});

document.getElementById('ingredients-container').addEventListener('dragleave', (e) => {
    // Clear borders when leaving the container
    if (e.target.id === 'ingredients-container') {
        document.querySelectorAll('.ingredient-row, .section-header').forEach(el => {
            el.style.borderTop = '';
            el.style.borderBottom = '';
        });
    }
});

document.getElementById('ingredients-container').addEventListener('drop', (e) => {
    e.preventDefault();
    
    // Clear all border indicators
    document.querySelectorAll('.ingredient-row, .section-header').forEach(el => {
        el.style.borderTop = '';
        el.style.borderBottom = '';
    });
    
    if (!draggedElement || !draggedElement.classList.contains('ingredient-row')) {
        return;
    }
    
    const container = document.getElementById('ingredients-container');
    const afterElement = getDragAfterElement(container, e.clientY);
    
    // Insert at the correct position (works across sections)
    if (afterElement == null) {
        // Drop at the end of the entire list
        container.appendChild(draggedElement);
    } else {
        // Drop before the target element (can be before/after section headers)
        container.insertBefore(draggedElement, afterElement);
    }
});

function getDragAfterElement(container, y) {
    // Get all ingredient rows except the one being dragged
    const draggableElements = [...container.querySelectorAll('.ingredient-row:not([style*="opacity: 0.5"])')];
    
    // Find the closest element below the cursor position
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        
        // If cursor is above this element and it's the closest one so far
        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// Mobile menu functionality
document.addEventListener('DOMContentLoaded', function() {
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
    const closeMobileMenu = document.getElementById('close-mobile-menu');
    const header = document.querySelector('header');
    
    function openMobileMenu() {
        mobileMenu.classList.remove('translate-x-full');
        mobileMenuOverlay.classList.remove('hidden');
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
        
        // Ensure header is visible and not affected by scroll behavior
        if (header) {
            header.style.transform = 'translateY(0)';
            header.style.visibility = 'visible';
        }
    }
    
    function closeMobileMenuFn() {
        mobileMenu.classList.add('translate-x-full');
        mobileMenuOverlay.classList.add('hidden');
        document.documentElement.style.overflow = '';
        document.body.style.overflow = '';
        
        // Reset header transform to allow scroll-based hiding to work again
        if (header) {
            header.style.transform = '';
            header.style.visibility = '';
        }
    }
    
    if (mobileMenuButton) {
        mobileMenuButton.addEventListener('click', openMobileMenu);
    }
    
    if (closeMobileMenu) {
        closeMobileMenu.addEventListener('click', closeMobileMenuFn);
    }
    
    if (mobileMenuOverlay) {
        mobileMenuOverlay.addEventListener('click', closeMobileMenuFn);
    }

    // Profile submenu toggle functionality
    const profileToggle = document.getElementById('mobile-profile-toggle');
    const profileSubmenu = document.getElementById('mobile-profile-submenu');
    const profileChevron = document.getElementById('mobile-profile-chevron');
    
    if (profileToggle && profileSubmenu && profileChevron) {
        profileToggle.addEventListener('click', function() {
            const isHidden = profileSubmenu.classList.contains('hidden');
            if (isHidden) {
                profileSubmenu.classList.remove('hidden');
                profileChevron.style.transform = 'rotate(180deg)';
            } else {
                profileSubmenu.classList.add('hidden');
                profileChevron.style.transform = 'rotate(0deg)';
            }
        });
    }
    
    // Load recipe for editing if URL parameter exists (AFTER all functions are defined and DOM is ready)
    if (recipeIdFromUrl) {
        loadRecipeForEditing(recipeIdFromUrl);
    }
});
</script>

</body></html>