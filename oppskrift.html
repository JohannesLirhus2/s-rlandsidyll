<!DOCTYPE html>

<html class="light" lang="no"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title id="page-title">SÃ¸rlandsidyll - Oppskrift</title>
<link rel="icon" type="image/png" href="assets/lime.png"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script type="module" src="assets/component-loader.js"></script>
<script src="assets/scripts.js"></script>
<script src="assets/header.js"></script>
<script type="module" src="assets/firebase.js"></script>
<script type="module" src="assets/auth.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700;900&amp;family=Playfair+Display:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<link href="assets/styles.css" rel="stylesheet"/>
<script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#334155",
                        "accent": "#0d9488",
                        "background-light": "#ffffff",
                        "slate-custom": "#f8fafc"
                    },
                    fontFamily: {
                        "display": ["Work Sans", "sans-serif"],
                        "serif": ["Playfair Display", "serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.125rem",
                        "lg": "0.375rem",
                        "xl": "0.5rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
<style>
        body { font-family: 'Work Sans', sans-serif; }
        .checkbox-custom:checked {
            background-color: #0d9488;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
        
        /* Mobile header - fixed positioning */
        @media (max-width: 768px) {
            header {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
            }
            
            body {
                padding-top: 64px; /* h-16 = 64px */
            }
            
            dialog {
                max-width: calc(100vw - 2rem) !important;
                max-height: calc(100vh - 2rem);
                margin: 1rem;
                width: calc(100vw - 2rem) !important;
            }
            dialog::backdrop {
                background: rgba(0, 0, 0, 0.5);
            }
        }
    </style>
</head>
<body class="antialiased overflow-x-hidden">
<header class="sticky top-0 z-50 w-full bg-white/95 backdrop-blur-sm border-b border-slate-200">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex items-center justify-between h-16">
<div class="flex items-center gap-6">
<!-- Logo -->
<div class="flex items-center cursor-pointer" onclick="window.location.href='index.html'">
<img src="assets/logo-small.png" alt="SÃ¸rlandsidyll" class="h-10 w-auto"/>
</div>
<!-- Header Search Bar -->
<div class="hidden md:flex items-center">
<div class="relative">
<button type="button" id="headerSearchButton" class="material-symbols-outlined text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 text-sm hover:text-accent transition-colors cursor-pointer z-10">search</button>
<input id="headerSearchInput" class="pl-9 pr-4 py-1.5 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-accent focus:border-transparent transition-all outline-none placeholder:text-slate-400 w-64" placeholder="SÃ¸k oppskrifter..." type="text"/>
</div>
</div>
<!-- End Left Group -->
</div>
<!-- Desktop Nav -->
<nav class="hidden md:flex items-center gap-2">
<a id="oppskrifter-link" class="text-xs font-semibold uppercase tracking-wider text-slate-600 hover:text-accent transition-colors px-3" href="index.html">alle oppskrifter</a>
<a id="om-oss-link" class="hidden text-xs font-semibold uppercase tracking-wider text-slate-600 hover:text-accent transition-colors px-3" href="#">Om oss</a>
<!-- Logged out buttons -->
<button id="login-button" class="text-xs font-bold px-3 py-1.5 hover:text-accent transition-all uppercase tracking-wider" onclick="window.location.href='login.html'">Logg inn</button>
<!-- Logged in profile menu (hidden by default) -->
<div id="profile-menu-container" class="hidden relative">
<button id="profile-menu-button" class="w-10 h-10 rounded-full bg-slate-200 overflow-hidden flex items-center justify-center hover:ring-2 hover:ring-accent transition-all" style="box-shadow: 0 0 0 1px #d1d5db, 0 0 0 2px #ffffff, 0 0 0 3px #d1d5db">
<img id="profile-menu-image" class="w-full h-full object-cover" alt="Profilbilde"/>
<span id="profile-menu-initials" class="text-xs font-bold text-slate-600"></span>
</button>
<!-- Dropdown menu -->
<div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-slate-200 z-50">
<button id="menu-new-recipe" class="hidden w-full text-left text-sm font-semibold uppercase tracking-wider text-slate-600 hover:bg-slate-50 px-4 py-3 border-b border-slate-200">Ny oppskrift</button>
<button id="menu-edit-recipes" class="hidden w-full text-left text-sm font-semibold uppercase tracking-wider text-slate-600 hover:bg-slate-50 px-4 py-3 border-b border-slate-200">Rediger oppskrifter</button>
<button id="menu-my-account" class="w-full text-left text-sm font-semibold uppercase tracking-wider text-slate-600 hover:bg-slate-50 px-4 py-3 border-b border-slate-200">Min konto</button>
<button id="menu-logout" class="w-full text-left text-sm font-semibold uppercase tracking-wider text-red-600 hover:bg-red-50 px-4 py-3">Logg ut</button>
</div>
</div>
</nav>
<!-- Mobile Menu Icon -->
<button id="mobile-menu-button" class="md:hidden flex items-center p-2 hover:bg-slate-100 rounded-lg transition-colors">
<span class="material-symbols-outlined text-slate-700">menu</span>
</button>
</div>
</div>

<!-- Mobile Menu Overlay -->
<div id="mobile-menu-overlay" class="hidden fixed inset-0 bg-black/50 z-40 md:hidden"></div>

<!-- Mobile Menu Drawer -->
<div id="mobile-menu" class="fixed top-0 right-0 bottom-0 h-screen w-80 shadow-xl transform translate-x-full transition-transform duration-300 z-50 md:hidden" style="background-color: #ffffff;">
<div class="flex flex-col h-full">
<!-- Mobile Menu Header -->
<div class="flex items-center justify-between px-4 py-4 border-b border-slate-200">
<h2 class="text-lg font-bold text-slate-800">Meny</h2>
<button id="close-mobile-menu" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
<span class="material-symbols-outlined text-slate-700">close</span>
</button>
</div>

<!-- Mobile Search -->
<div class="px-4 py-3 border-b border-slate-200">
<div class="relative">
<span class="material-symbols-outlined text-slate-400 absolute left-3 top-1/2 -translate-y-1/2 text-sm">search</span>
<input id="mobileSearchInput" class="w-full pl-9 pr-4 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-accent focus:border-transparent transition-all outline-none placeholder:text-slate-400" placeholder="SÃ¸k oppskrifter..." type="text"/>
</div>
</div>

<!-- Mobile Navigation Links -->
<nav class="flex-1 overflow-y-auto bg-white">
<!-- Always visible: Alle oppskrifter -->
<a href="index.html" class="block px-4 py-3 text-sm font-semibold uppercase tracking-wider text-slate-600 hover:bg-slate-50 border-b border-slate-200">Alle oppskrifter</a>

<!-- Login button (visible when logged out) -->
<a id="mobile-login-button" href="login.html" class="block px-4 py-3 text-sm font-semibold uppercase tracking-wider text-accent hover:bg-slate-50 border-b border-slate-200">Logg inn</a>

<!-- Profile Section (visible when logged in) -->
<div id="mobile-profile-section" class="hidden">
<!-- Profile Header with Avatar (Clickable Toggle) -->
<button id="mobile-profile-toggle" class="w-full px-4 py-3 border-b border-slate-200 bg-slate-50 hover:bg-slate-100 transition-colors">
<div class="flex items-center gap-3">
<div id="mobile-profile-avatar" class="w-12 h-12 rounded-full bg-slate-200 overflow-hidden flex items-center justify-center" style="box-shadow: 0 0 0 1px #d1d5db">
<img id="mobile-profile-image" class="w-full h-full object-cover hidden" alt="Profilbilde"/>
<span id="mobile-profile-initials" class="text-sm font-bold text-slate-600"></span>
</div>
<div class="flex-1 min-w-0 text-left">
<p id="mobile-profile-name" class="text-sm font-semibold text-slate-800 truncate"></p>
<p class="text-xs text-slate-500">Innlogget</p>
</div>
<span id="mobile-profile-chevron" class="material-symbols-outlined text-slate-400 transition-transform duration-200">expand_more</span>
</div>
</button>
<!-- Profile Submenu Items (Hidden by default) -->
<div id="mobile-profile-submenu" class="hidden bg-slate-50">
<a id="mobile-menu-new-recipe" href="ny-oppskrift.html" class="hidden block px-4 py-3 pl-8 text-sm font-semibold uppercase tracking-wider text-slate-600 hover:bg-slate-100 border-b border-slate-200">Ny oppskrift</a>
<a id="mobile-menu-my-recipes" href="#" class="block px-4 py-3 pl-8 text-sm font-semibold uppercase tracking-wider text-slate-600 hover:bg-slate-100 border-b border-slate-200">Mine oppskrifter</a>
<a id="mobile-menu-edit-recipes" href="#" class="hidden block px-4 py-3 pl-8 text-sm font-semibold uppercase tracking-wider text-slate-600 hover:bg-slate-100 border-b border-slate-200">Rediger oppskrifter</a>
<a id="mobile-menu-my-account" href="min-konto.html" class="block px-4 py-3 pl-8 text-sm font-semibold uppercase tracking-wider text-slate-600 hover:bg-slate-100 border-b border-slate-200">Min konto</a>
<button id="mobile-menu-logout" class="w-full text-left px-4 py-3 pl-8 text-sm font-semibold uppercase tracking-wider text-red-600 hover:bg-red-50 border-b border-slate-200">Logg ut</button>
</div>
</div>
</nav>
</div>
</div>
</header>
<main class="max-w-6xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
<!-- Hero Section -->
<section class="relative mb-12">
<div class="relative h-[500px] w-full overflow-hidden rounded-xl shadow-2xl">
<div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent z-10"></div>
<img id="recipe-hero-image" class="w-full h-full object-cover transform hover:scale-105 transition-transform duration-700" alt="Recipe image" src="https://via.placeholder.com/1200x500?text=Loading..."/>
<div class="absolute bottom-0 left-0 p-8 z-20 w-full">
<div class="flex flex-col gap-2">
<div id="recipe-categories" class="flex gap-2 mb-2"></div>
<h1 id="recipe-title" class="text-4xl md:text-5xl font-bold text-white mb-2">Laster oppskrift...</h1>
<p id="recipe-description" class="text-slate-200 text-lg max-w-2xl leading-relaxed"></p>
</div>
</div>
</div>
</section>
<!-- Stats Bar -->
<section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-12">
<div class="bg-white p-6 rounded-xl border border-slate-200 flex flex-col items-center text-center shadow-sm hidden">
<span class="material-symbols-outlined text-accent mb-2 text-3xl">schedule</span>
<span class="text-xs font-semibold text-slate-500 uppercase tracking-widest">Prep Time</span>
<span class="text-xl font-bold text-slate-900">30 mins</span>
</div>
<div class="bg-white p-6 rounded-xl border border-slate-200 flex flex-col items-center text-center shadow-sm hidden">
<span class="material-symbols-outlined text-accent mb-2 text-3xl">signal_cellular_alt</span>
<span class="text-xs font-semibold text-slate-500 uppercase tracking-widest">Difficulty</span>
<span class="text-xl font-bold text-slate-900">Easy</span>
</div>
<div class="bg-white p-6 rounded-xl border border-slate-200 flex flex-col items-center text-center shadow-sm">
<span class="material-symbols-outlined text-accent mb-2 text-3xl">groups</span>
<span class="text-xs font-semibold text-slate-500 uppercase tracking-widest">Porsjoner</span>
<div class="flex items-center gap-3 mt-3">
<button id="portions-minus" class="text-accent hover:text-accent/80 font-bold text-lg hover:bg-accent/10 px-2 py-1 rounded transition-colors" aria-label="Decrease portions">âˆ’</button>
<span id="recipe-portions" class="text-xl font-bold text-slate-900 min-w-8 text-center">-</span>
<button id="portions-plus" class="text-accent hover:text-accent/80 font-bold text-lg hover:bg-accent/10 px-2 py-1 rounded transition-colors" aria-label="Increase portions">+</button>
</div>
</div>
<div class="bg-white p-6 rounded-xl border border-slate-200 flex flex-col items-center text-center shadow-sm hidden">
<span class="material-symbols-outlined text-accent mb-2 text-3xl">local_fire_department</span>
<span class="text-xs font-semibold text-slate-500 uppercase tracking-widest">Calories</span>
<span class="text-xl font-bold text-slate-900">450 kcal</span>
</div>
</section>
<!-- Main Content: Two Columns (Desktop) / Stacked (Mobile) -->
<div class="grid grid-cols-1 gap-12">
<!-- Top Row: Ingredients (Left) and Instructions (Right) on Desktop -->
<div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
<!-- Left Column: Ingredients -->
<aside class="lg:col-span-5">
<div class="sticky top-28">
<h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
<span class="w-1.5 h-8 bg-accent rounded-full"></span>
                        Ingredienser
                    </h2>
<div id="recipe-ingredients" class="bg-white rounded-xl p-8 border border-slate-200 shadow-sm space-y-4">
<p class="text-slate-500 text-sm">Laster ingredienser...</p>
</div>
<!-- Nutrition Table -->
<div class="mt-8 bg-accent/5 rounded-xl p-6 border border-accent/20 hidden">
<h3 class="text-sm font-bold text-slate-900 mb-4 flex items-center gap-2">
<span class="material-symbols-outlined text-accent text-xl">nutrition</span>
                            Nutrition Facts (per portion)
                        </h3>
<div class="space-y-3">
<div class="flex justify-between text-sm">
<span class="text-slate-600">Total Fat</span>
<span class="font-bold">28g</span>
</div>
<div class="flex justify-between text-sm">
<span class="text-slate-600">Carbohydrates</span>
<span class="font-bold">12g</span>
</div>
<div class="flex justify-between text-sm">
<span class="text-slate-600">Protein</span>
<span class="font-bold">34g</span>
</div>
<div class="flex justify-between text-sm">
<span class="text-slate-600">Sodium</span>
<span class="font-bold">850mg</span>
</div>
</div>
</div>
</div>
</aside>
<!-- Right Column: Instructions -->
<article class="lg:col-span-7">
<h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
<span class="w-1.5 h-8 bg-accent rounded-full"></span>
                    Instruksjoner
                </h2>
<div id="recipe-instructions" class="space-y-8">
<p class="text-slate-500 text-sm">Laster instruksjoner...</p>
</div>
<!-- Chef's Tip Box -->
<div class="bg-accent/10 border-l-4 border-accent p-6 rounded-r-xl my-10 shadow-sm hidden">
<div class="flex items-start gap-4">
<span class="material-symbols-outlined text-accent text-3xl">lightbulb</span>
<div>
<h4 class="font-bold text-slate-900 mb-1">Chef's Secret Tip</h4>
<p class="text-slate-700 italic leading-relaxed">"Add a splash of apple cider vinegar at the end to brighten the cream broth. It cuts through the richness and highlights the fresh ocean flavor of the cod."</p>
</div>
</div>
</div>
<!-- Author Section -->
<a id="recipe-author-link" href="" class="mt-8 p-6 bg-slate-50 rounded-xl border border-slate-200 hover:border-accent hover:bg-slate-100/50 transition-all inline-block cursor-pointer no-underline">
<div id="recipe-author" class="flex items-center gap-4">
<div id="author-avatar" class="w-14 h-14 rounded-full bg-slate-200 overflow-hidden flex items-center justify-center flex-shrink-0" style="box-shadow: 0 0 0 1px #d1d5db">
<img id="author-image" class="w-full h-full object-cover hidden" alt="Forfatter"/>
<span id="author-initials" class="text-sm font-bold text-slate-600"></span>
</div>
<div>
<p class="text-xs font-semibold uppercase tracking-wider text-slate-500 mb-1">Forfatter</p>
<p id="author-name" class="text-lg font-bold text-slate-800">-</p>
</div>
</div>
</a>
<!-- Action Buttons -->
<div class="mt-12 flex flex-wrap gap-4 border-t border-slate-200 pt-8">
<button id="print-recipe-btn" class="px-6 py-3 bg-accent hover:bg-teal-700 text-white font-bold rounded-lg flex items-center gap-2 transition-all">
<span class="material-symbols-outlined">print</span> Print Recipe
                    </button>
<button class="px-6 py-3 border border-slate-200 hover:bg-slate-50 font-bold rounded-lg flex items-center gap-2 transition-all hidden">
<span class="material-symbols-outlined">share</span> Share
                    </button>
<button class="px-6 py-3 border border-slate-200 hover:bg-slate-50 font-bold rounded-lg flex items-center gap-2 transition-all hidden">
<span class="material-symbols-outlined">favorite</span> Save to Favorites
                    </button>
</div>
</div>
</main>

<!-- Hidden Print View -->
<div id="print-view" class="hidden print:block print:w-full print:bg-white print:p-0">
  <style>
    @media print {
      * {
        margin: 0;
        padding: 0;
      }
      
      body {
        background: white;
        font-family: 'Work Sans', Arial, sans-serif;
        line-height: 1.6;
        color: #1f2937;
      }
      
      header, nav, main, aside, #footer-placeholder, #recipe-author-link, #print-recipe-btn, .no-print {
        display: none !important;
      }
      
      #print-view {
        display: block !important;
        width: 100% !important;
        padding: 40px;
      }
      
            #print-logo {
                width: 200px;
                height: auto;
                margin: 0 auto 24px;
                display: block;
            }
      
            #print-title {
                font-size: 2em;
                font-weight: bold;
                margin-bottom: 12px;
                color: #1f2937;
                text-align: center;
            }
      
            #print-image {
                display: none;
            }
      
            .print-section {
                margin-bottom: 30px;
                page-break-inside: avoid;
            }

            #print-ingredients-section {
                page-break-inside: auto;
                break-inside: auto;
            }

            #print-ingredients-content {
                column-count: 2;
                column-gap: 24px;
            }

            #print-ingredients-content > * {
                break-inside: avoid;
            }
      
            .print-section-title {
        font-size: 1.3em;
        font-weight: bold;
        margin-bottom: 15px;
        margin-top: 20px;
        color: #1f2937;
        border-bottom: 2px solid #0d9488;
        padding-bottom: 8px;
      }

            #print-ingredients-section .print-section-title {
                margin-top: 0;
            }
      
      .print-ingredients-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      
      .print-ingredient-item {
        margin-bottom: 8px;
        text-align: left;
      }

            .print-ingredient-sub {
                margin: 2px 0 8px 16px;
                color: #4b5563;
                font-style: italic;
            }

            .print-ingredient-section-title {
                column-span: all;
            }

            .print-ingredient-divider {
                column-span: all;
                border-top: 1px dashed #0d9488;
                margin: 8px 0 12px;
            }
      
      .print-instructions-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      
      .print-instruction-item {
        margin-bottom: 15px;
        padding-left: 30px;
        position: relative;
      }
      
      .print-instruction-number {
        position: absolute;
        left: 0;
        font-weight: bold;
        color: #0d9488;
        width: 20px;
      }
      
      .print-tip {
        margin-top: 10px;
        margin-left: 30px;
        padding: 10px;
        background: #fef3c7;
        border-left: 3px solid #f59e0b;
        font-style: italic;
      }
      
      .print-tips-box {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        padding: 15px;
        margin-bottom: 10px;
      }

            .print-author-box {
                display: flex;
                align-items: center;
                gap: 12px;
                border: 1px solid #e5e7eb;
                padding: 12px;
                border-radius: 8px;
            }

            #print-author-image {
                width: 48px;
                height: 48px;
                border-radius: 9999px;
                object-fit: cover;
            }

            .print-author-label {
                font-size: 0.75em;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                color: #6b7280;
                margin-bottom: 4px;
            }
    }
  </style>
  
  <div id="print-content">
    <!-- Logo -->
    <img id="print-logo" src="assets/logo-small.png" alt="SÃ¸rlandsidyll"/>
    
    <!-- Title -->
    <h1 id="print-title"></h1>

        <!-- Author Section -->
        <div id="print-author-section" class="print-section" style="display: none;">
            <div class="print-author-box">
                <img id="print-author-image" src="" alt="Forfatter"/>
                <div>
                    <div class="print-author-label">Forfatter</div>
                    <div id="print-author-name"></div>
                </div>
            </div>
        </div>
    
        <!-- Ingredients Section -->
        <div id="print-ingredients-section" class="print-section">
      <div class="print-section-title">Ingredienser</div>
      <div id="print-ingredients-content"></div>
    </div>

    
    <!-- Instructions Section -->
    <div class="print-section">
      <div class="print-section-title">Instruksjoner</div>
      <div id="print-instructions-content"></div>
    </div>
    
    <!-- General Tips Section -->
    <div id="print-tips-section" class="print-section" style="display: none;">
      <div class="print-section-title">Generelle tips</div>
      <div id="print-tips-content"></div>
    </div>

  </div>
</div>

<div id="footer-placeholder"></div>

<script type="module">
import { db } from './assets/firebase.js';
import { doc, getDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js';

// Get recipe ID from URL parameters
const urlParams = new URLSearchParams(window.location.search);
const recipeId = urlParams.get('id');
let printAuthorData = { name: '', image: '' };

// Redirect to index if no ID provided
if (!recipeId) {
    window.location.href = 'index.html';
}

// Load recipe from Firebase
async function loadRecipe() {
    try {
        const recipeDoc = await getDoc(doc(db, 'recipes', recipeId));
        
        if (!recipeDoc.exists()) {
            console.error('Recipe not found');
            window.location.href = 'index.html';
            return;
        }
        
        const recipe = recipeDoc.data();
        
        // Block deleted recipes from being viewed
        if (recipe.deleted === true) {
            console.error('Recipe has been deleted');
            window.location.href = 'index.html';
            return;
        }
        
        console.log('Loaded recipe:', recipe);
        
        // Update page title
        document.getElementById('page-title').textContent = `${recipe.title || 'Oppskrift'} - SÃ¸rlandsidyll`;
        
        // Update hero section
        document.getElementById('recipe-title').textContent = recipe.title || 'Uten tittel';
        document.getElementById('recipe-description').textContent = recipe.description || '';
        
        // Update hero image
        const heroImage = document.getElementById('recipe-hero-image');
        if (recipe.img_url) {
            heroImage.src = recipe.img_url;
            heroImage.alt = recipe.title || 'Oppskrift';
        } else {
            heroImage.src = 'https://via.placeholder.com/1200x500?text=Ingen+bilde';
        }
        
        // Display category badges
        const categoriesContainer = document.getElementById('recipe-categories');
        categoriesContainer.innerHTML = '';
        
        // Fetch category mappings from Firebase
        try {
            const categoriesRef = collection(db, 'cathegories');
            const categoriesSnapshot = await getDocs(categoriesRef);
            const categoryNames = {};
            
            // Build mapping of category IDs to names
            categoriesSnapshot.forEach((doc) => {
                const categoryData = doc.data();
                const categoryId = doc.id; // e.g., "tbakst"
                const categoryName = categoryData.name; // e.g., "Bakst"
                categoryNames[categoryId] = categoryName;
            });
            
            // Display badges for categories where recipe[categoryId] === true
            Object.keys(categoryNames).forEach(key => {
                if (recipe[key] === true) {
                    const badge = document.createElement('span');
                    badge.className = 'inline-block px-3 py-1 bg-accent text-white text-xs font-bold uppercase tracking-wider rounded-full';
                    badge.textContent = categoryNames[key];
                    categoriesContainer.appendChild(badge);
                }
            });
        } catch (error) {
            console.error('Error loading categories:', error);
        }
        
        // Update portions
        if (recipe.base_portions) {
            document.getElementById('recipe-portions').textContent = recipe.base_portions + ' porsjoner';
        }
        
        // Set up portions +/- buttons
        let currentPortions = recipe.base_portions || 1;
        const basePortions = recipe.base_portions || 1;
        const portionsDisplay = document.getElementById('recipe-portions');
        const portionsMinus = document.getElementById('portions-minus');
        const portionsPlus = document.getElementById('portions-plus');
        
        if (portionsMinus) {
            portionsMinus.addEventListener('click', () => {
                if (currentPortions > 1) {
                    currentPortions--;
                    portionsDisplay.textContent = currentPortions + ' porsjoner';
                    updateIngredientAmounts();
                }
            });
        }
        
        if (portionsPlus) {
            portionsPlus.addEventListener('click', () => {
                currentPortions++;
                portionsDisplay.textContent = currentPortions + ' porsjoner';
                updateIngredientAmounts();
            });
        }
        
        function updateIngredientAmounts() {
            const multiplier = currentPortions / basePortions;
            const ingredientSpans = document.querySelectorAll('#recipe-ingredients label span:not(.material-symbols-outlined)');
            
            ingredientSpans.forEach((span) => {
                const originalText = span.getAttribute('data-original-text') || span.textContent;
                if (!span.getAttribute('data-original-text')) {
                    span.setAttribute('data-original-text', originalText);
                }
                
                // Parse amount, unit, and name from original text
                const match = originalText.match(/^([\d.,]*\s*\d*\/\d*|[\d.,]+)?\s*([a-z]*|dl|ml|g|kg|tsk|ss|stk)?\s*(.+)$/i);
                if (match) {
                    let amount = match[1] ? match[1].trim() : '';
                    const unit = match[2] ? match[2].trim() : '';
                    const name = match[3] ? match[3].trim() : '';
                    
                    // Try to parse and scale the amount
                    if (amount) {
                        // Handle fractions like 1/2
                        if (amount.includes('/')) {
                            const [numerator, denominator] = amount.split('/');
                            const numValue = parseFloat(numerator) / parseFloat(denominator);
                            const scaled = numValue * multiplier;
                            amount = scaled.toFixed(2).replace(/\.?0+$/, '');
                        } else {
                            // Handle decimal numbers
                            const numValue = parseFloat(amount);
                            if (!isNaN(numValue)) {
                                const scaled = numValue * multiplier;
                                amount = scaled.toFixed(2).replace(/\.?0+$/, '');
                            }
                        }
                    }
                    
                    // Reconstruct the text
                    span.textContent = `${amount} ${unit} ${name}`.trim();
                }
            });
        }
        
        // Populate print view with recipe data
        function populatePrintView(recipe) {
            // Set title
            document.getElementById('print-title').textContent = recipe.title || 'Oppskrift';
            
            // Print image removed from layout
            
            // Populate ingredients
            const ingredientsContent = document.getElementById('print-ingredients-content');
            ingredientsContent.innerHTML = '';
            
            if (recipe.ingredient_sections && recipe.ingredient_sections.length > 0) {
                recipe.ingredient_sections.forEach((section, sectionIndex) => {
                    let hasItems = false;
                    if (section.title) {
                        const sectionTitle = document.createElement('div');
                        sectionTitle.className = 'print-ingredient-section-title';
                        sectionTitle.style.fontWeight = 'bold';
                        sectionTitle.style.marginTop = '15px';
                        sectionTitle.style.marginBottom = '8px';
                        sectionTitle.textContent = section.title;
                        ingredientsContent.appendChild(sectionTitle);
                    }
                    
                    if (section.ingredients && section.ingredients.length > 0) {
                        section.ingredients.forEach((ingredient) => {
                            hasItems = true;
                            const amount = ingredient.amount || '';
                            const unit = ingredient.unit || '';
                            const name = ingredient.name || '';
                            const text = `${amount} ${unit} ${name}`.trim();
                            
                            const item = document.createElement('div');
                            item.className = 'print-ingredient-item';
                            item.textContent = text;
                            ingredientsContent.appendChild(item);

                            if (ingredient.substitutions && ingredient.substitutions.length > 0) {
                                ingredient.substitutions.forEach((sub) => {
                                    hasItems = true;
                                    const subAmount = sub.amount || '';
                                    const subUnit = sub.unit || '';
                                    const subName = sub.name || '';
                                    const subText = `Alt: ${subAmount} ${subUnit} ${subName}`.trim();

                                    const subItem = document.createElement('div');
                                    subItem.className = 'print-ingredient-sub';
                                    subItem.textContent = subText;
                                    ingredientsContent.appendChild(subItem);
                                });
                            }
                        });
                    }

                    if (hasItems && sectionIndex < recipe.ingredient_sections.length - 1) {
                        const divider = document.createElement('div');
                        divider.className = 'print-ingredient-divider';
                        ingredientsContent.appendChild(divider);
                    }

                });
            } else if (recipe.ingr && recipe.ingr.length > 0) {
                recipe.ingr.forEach((ingredient, index) => {
                    const number = recipe.ingr_numb && recipe.ingr_numb[index] ? recipe.ingr_numb[index] : '';
                    const unit = recipe.ingr_unit && recipe.ingr_unit[index] ? recipe.ingr_unit[index] : '';
                    const text = `${number} ${unit} ${ingredient}`.trim();
                    
                    const item = document.createElement('div');
                    item.className = 'print-ingredient-item';
                    item.textContent = text;
                    ingredientsContent.appendChild(item);
                });
            }
            
            // Populate instructions
            const instructionsContent = document.getElementById('print-instructions-content');
            instructionsContent.innerHTML = '';
            
            if (recipe.instruction_sections && recipe.instruction_sections.length > 0) {
                let stepCounter = 1;
                recipe.instruction_sections.forEach((section) => {
                    if (section.title) {
                        const sectionTitle = document.createElement('div');
                        sectionTitle.style.fontWeight = 'bold';
                        sectionTitle.style.marginTop = '15px';
                        sectionTitle.style.marginBottom = '8px';
                        sectionTitle.textContent = section.title;
                        instructionsContent.appendChild(sectionTitle);
                    }
                    
                    if (section.steps && section.steps.length > 0) {
                        section.steps.forEach((stepData) => {
                            const stepText = typeof stepData === 'string' ? stepData : (stepData.text || stepData);
                            const stepTips = typeof stepData === 'object' && stepData.tips ? stepData.tips : [];
                            
                            const stepDiv = document.createElement('div');
                            stepDiv.className = 'print-instruction-item';
                            
                            const stepContent = document.createElement('div');
                            stepContent.innerHTML = `<span class="print-instruction-number">${stepCounter}.</span><div>${stepText}</div>`;
                            stepDiv.appendChild(stepContent);
                            
                            if (stepTips.length > 0) {
                                stepTips.forEach(tipText => {
                                    const tipDiv = document.createElement('div');
                                    tipDiv.className = 'print-tip';
                                    tipDiv.textContent = 'ðŸ’¡ ' + tipText;
                                    stepDiv.appendChild(tipDiv);
                                });
                            }
                            
                            instructionsContent.appendChild(stepDiv);
                            stepCounter++;
                        });
                    }
                });
            } else if (recipe.instr && recipe.instr.length > 0) {
                recipe.instr.forEach((instruction, index) => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'print-instruction-item';
                    stepDiv.innerHTML = `<span class="print-instruction-number">${index + 1}.</span><div>${instruction}</div>`;
                    instructionsContent.appendChild(stepDiv);
                });
            }
            
            // Populate global tips
            const tipsSectionEl = document.getElementById('print-tips-section');
            const tipsContent = document.getElementById('print-tips-content');
            tipsContent.innerHTML = '';
            
            if (recipe.global_tips && recipe.global_tips.length > 0) {
                tipsSectionEl.style.display = 'block';
                recipe.global_tips.forEach(tipText => {
                    const tipDiv = document.createElement('div');
                    tipDiv.className = 'print-tips-box';
                    tipDiv.textContent = 'ðŸ’¡ ' + tipText;
                    tipsContent.appendChild(tipDiv);
                });
            } else {
                tipsSectionEl.style.display = 'none';
            }

            // Populate author
            const authorSectionEl = document.getElementById('print-author-section');
            const authorNameEl = document.getElementById('print-author-name');
            const authorImageEl = document.getElementById('print-author-image');

            if (printAuthorData.name) {
                authorSectionEl.style.display = 'block';
                authorNameEl.textContent = printAuthorData.name;

                if (printAuthorData.image) {
                    authorImageEl.src = printAuthorData.image;
                    authorImageEl.style.display = 'block';
                } else {
                    authorImageEl.style.display = 'none';
                }
            } else {
                authorSectionEl.style.display = 'none';
            }
        }
        
        // Add print functionality
        const printBtn = document.getElementById('print-recipe-btn');
        if (printBtn) {
            printBtn.addEventListener('click', () => {
                populatePrintView(recipe);
                window.print();
            });
        }

        // Populate print view for Ctrl+P / browser print
        window.addEventListener('beforeprint', () => {
            populatePrintView(recipe);
        });

        const printMedia = window.matchMedia('print');
        if (printMedia && typeof printMedia.addEventListener === 'function') {
            printMedia.addEventListener('change', (event) => {
                if (event.matches) {
                    populatePrintView(recipe);
                }
            });
        }
        
        
        // Display ingredients
        const ingredientsContainer = document.getElementById('recipe-ingredients');
        ingredientsContainer.innerHTML = '';
        
        // Check if we have the new section-based structure
        if (recipe.ingredient_sections && recipe.ingredient_sections.length > 0) {
            // NEW FORMAT: Display ingredients grouped by sections
            recipe.ingredient_sections.forEach((section) => {
                // Add section header if section has a title
                if (section.title) {
                    const sectionHeader = document.createElement('h4');
                    sectionHeader.className = 'text-lg font-bold text-slate-800 mt-6 mb-3 first:mt-0';
                    sectionHeader.textContent = section.title;
                    ingredientsContainer.appendChild(sectionHeader);
                }
                
                // Add ingredients for this section
                if (section.ingredients && section.ingredients.length > 0) {
                    section.ingredients.forEach((ingredient) => {
                        const amount = ingredient.amount || '';
                        const unit = ingredient.unit || '';
                        const name = ingredient.name || '';
                        
                        // Main ingredient row
                        const label = document.createElement('label');
                        label.className = 'flex items-center gap-3 cursor-pointer group';
                        const ingredientText = `${amount} ${unit} ${name}`.trim();
                        label.innerHTML = `
                            <input class="checkbox-custom w-5 h-5 rounded border-2 border-slate-300 text-accent focus:ring-accent bg-transparent transition-all" type="checkbox"/>
                            <span class="text-slate-700 group-hover:text-accent transition-colors" data-original-text="${ingredientText}">${ingredientText}</span>
                        `;
                        ingredientsContainer.appendChild(label);
                        
                        // Add substitutions button if they exist
                        if (ingredient.substitutions && ingredient.substitutions.length > 0) {
                            const substitutionsDiv = document.createElement('div');
                            substitutionsDiv.className = 'ml-8 mt-2 hidden substitutions-list';
                            
                            const showSubBtn = document.createElement('button');
                            showSubBtn.className = 'flex items-center gap-2 text-sm text-slate-500 hover:text-primary transition-colors mb-2';
                            showSubBtn.innerHTML = '<span class="material-symbols-outlined text-base">swap_horiz</span> <span>Vis alternativer</span>';
                            showSubBtn.setAttribute('type', 'button');
                            
                            showSubBtn.addEventListener('click', (e) => {
                                e.preventDefault();
                                substitutionsDiv.classList.toggle('hidden');
                                showSubBtn.querySelector('span:last-child').textContent = 
                                    substitutionsDiv.classList.contains('hidden') ? 'Vis alternativer' : 'Skjul alternativer';
                            });
                            
                            ingredientsContainer.appendChild(showSubBtn);
                            
                            ingredient.substitutions.forEach((sub) => {
                                const subLabel = document.createElement('label');
                                subLabel.className = 'flex items-center gap-3 cursor-pointer group ml-4';
                                const subAmount = sub.amount || '';
                                const subUnit = sub.unit || '';
                                const subName = sub.name || '';
                                const subIngredientText = `(alt) ${subAmount} ${subUnit} ${subName}`.trim();
                                
                                subLabel.innerHTML = `
                                    <input class="checkbox-custom w-5 h-5 rounded border-2 border-slate-300 text-accent focus:ring-accent bg-transparent transition-all" type="checkbox"/>
                                    <span class="text-slate-600 text-sm group-hover:text-accent transition-colors italic" data-original-text="${subIngredientText}">${subIngredientText}</span>
                                `;
                                substitutionsDiv.appendChild(subLabel);
                            });
                            
                            ingredientsContainer.appendChild(substitutionsDiv);
                        }
                    });
                }
            });
        } else if (recipe.ingr_title && recipe.ingr_title.length > 0) {
            // OLD FORMAT: Display flat list of ingredients (backward compatibility)
            recipe.ingr_title.forEach((title, index) => {
                const label = document.createElement('label');
                label.className = 'flex items-center gap-3 cursor-pointer group';
                
                const number = recipe.ingr_numb && recipe.ingr_numb[index] ? recipe.ingr_numb[index] : '';
                const unit = recipe.ingr_unit && recipe.ingr_unit[index] ? recipe.ingr_unit[index] : '';
                const ingredientText = `${number} ${unit} ${title}`.trim();
                
                label.innerHTML = `
                    <input class="checkbox-custom w-5 h-5 rounded border-2 border-slate-300 text-accent focus:ring-accent bg-transparent transition-all" type="checkbox"/>
                    <span class="text-slate-700 group-hover:text-accent transition-colors" data-original-text="${ingredientText}">${ingredientText}</span>
                `;
                
                ingredientsContainer.appendChild(label);
            });
        } else {
            ingredientsContainer.innerHTML = '<p class="text-slate-500 text-sm">Ingen ingredienser tilgjengelig.</p>';
        }
        
        // Display instructions
        const instructionsContainer = document.getElementById('recipe-instructions');
        instructionsContainer.innerHTML = '';
        
        // Check if we have the new section-based structure
        if (recipe.instruction_sections && recipe.instruction_sections.length > 0) {
            // NEW FORMAT: Display instructions grouped by sections
            let stepCounter = 1;
            recipe.instruction_sections.forEach((section) => {
                // Add section header if section has a title
                if (section.title) {
                    const sectionHeader = document.createElement('h4');
                    sectionHeader.className = 'text-lg font-bold text-slate-800 mt-8 mb-4 first:mt-0';
                    sectionHeader.textContent = section.title;
                    instructionsContainer.appendChild(sectionHeader);
                }
                
                // Add steps for this section
                if (section.steps && section.steps.length > 0) {
                    section.steps.forEach((stepData) => {
                        // Handle both old format (string) and new format (object with text and tips)
                        const stepText = typeof stepData === 'string' ? stepData : (stepData.text || stepData);
                        const stepTips = typeof stepData === 'object' && stepData.tips ? stepData.tips : [];
                        
                        const instructionDiv = document.createElement('div');
                        instructionDiv.className = 'mb-6';
                        
                        const stepRow = document.createElement('div');
                        stepRow.className = 'flex gap-6';
                        stepRow.innerHTML = `
                            <span class="flex-none w-10 h-10 rounded-full bg-accent text-white flex items-center justify-center font-bold text-lg">${stepCounter}</span>
                            <div>
                                <p class="text-slate-600 leading-relaxed">${stepText}</p>
                            </div>
                        `;
                        
                        instructionDiv.appendChild(stepRow);
                        
                        // Add tips if they exist
                        if (stepTips.length > 0) {
                            const tipsContainer = document.createElement('div');
                            tipsContainer.className = 'ml-16 mt-3 space-y-2';
                            
                            stepTips.forEach(tipText => {
                                const tipDiv = document.createElement('div');
                                tipDiv.className = 'flex gap-3 p-3 bg-amber-50 dark:bg-amber-900/10 rounded-lg border border-dashed border-amber-200 dark:border-amber-800';
                                tipDiv.innerHTML = `
                                    <span class="material-symbols-outlined text-amber-500 text-sm mt-0.5">lightbulb</span>
                                    <p class="text-sm text-amber-800 dark:text-amber-200 leading-relaxed">${tipText}</p>
                                `;
                                tipsContainer.appendChild(tipDiv);
                            });
                            
                            instructionDiv.appendChild(tipsContainer);
                        }
                        
                        instructionsContainer.appendChild(instructionDiv);
                        stepCounter++;
                    });
                }
            });
        } else if (recipe.instr && recipe.instr.length > 0) {
            // OLD FORMAT: Display flat list of instructions (backward compatibility)
            recipe.instr.forEach((instruction, index) => {
                const instructionDiv = document.createElement('div');
                instructionDiv.className = 'flex gap-6';
                
                instructionDiv.innerHTML = `
                    <span class="flex-none w-10 h-10 rounded-full bg-accent text-white flex items-center justify-center font-bold text-lg">${index + 1}</span>
                    <div>
                        <p class="text-slate-600 leading-relaxed">${instruction}</p>
                    </div>
                `;
                
                instructionsContainer.appendChild(instructionDiv);
            });
        } else {
            instructionsContainer.innerHTML = '<p class="text-slate-500 text-sm">Ingen instruksjoner tilgjengelig.</p>';
        }
        
        // Display global tips
        const globalTipsSection = document.getElementById('recipe-global-tips') || document.createElement('section');
        if (!globalTipsSection.id) {
            globalTipsSection.id = 'recipe-global-tips';
            // Find the recipe author section and insert before it
            const authorSection = document.querySelector('#recipe-author')?.parentElement || document.body;
            authorSection.parentElement.insertBefore(globalTipsSection, authorSection);
        }
        globalTipsSection.innerHTML = '';
        
        if (recipe.global_tips && recipe.global_tips.length > 0) {
            globalTipsSection.className = 'bg-white dark:bg-slate-900 p-6 md:p-8 rounded-xl shadow-sm border border-slate-100 dark:border-slate-800 mt-8';
            
            const title = document.createElement('h3');
            title.className = 'text-xl font-bold flex items-center gap-2 mb-4';
            title.innerHTML = '<span class="material-symbols-outlined text-amber-500">lightbulb</span> Generelle tips';
            globalTipsSection.appendChild(title);
            
            const tipsContainer = document.createElement('div');
            tipsContainer.className = 'space-y-4';
            
            recipe.global_tips.forEach(tipText => {
                const tipDiv = document.createElement('div');
                tipDiv.className = 'flex gap-4 p-4 bg-amber-50 dark:bg-amber-900/10 rounded-lg border border-dashed border-amber-200 dark:border-amber-800';
                tipDiv.innerHTML = `
                    <span class="material-symbols-outlined text-amber-500 flex-shrink-0 mt-0.5">lightbulb</span>
                    <p class="text-amber-900 dark:text-amber-100 leading-relaxed">${tipText}</p>
                `;
                tipsContainer.appendChild(tipDiv);
            });
            
            globalTipsSection.appendChild(tipsContainer);
        }
        
        // Display author
        if (recipe.author) {
            // Fetch author details from Firebase
            try {
                const authorRef = doc(db, 'authors', recipe.author);
                const authorDoc = await getDoc(authorRef);
                
                if (authorDoc.exists()) {
                    const authorData = authorDoc.data();
                    const publicName = authorData.public_name || authorData['public-name'] || recipe.author;
                    const authorImage = authorData.img;
                    printAuthorData = { name: publicName, image: authorImage || '' };
                    
                    // Update author link with GET parameter
                    const authorLink = document.getElementById('recipe-author-link');
                    authorLink.href = `konto.html?author=${encodeURIComponent(recipe.author)}`;
                    
                    // Update author name
                    const authorNameEl = document.getElementById('author-name');
                    authorNameEl.textContent = publicName;
                    
                    // Update author image or initials
                    const authorImageEl = document.getElementById('author-image');
                    const authorInitialsEl = document.getElementById('author-initials');
                    
                    if (authorImage) {
                        authorImageEl.src = authorImage;
                        authorImageEl.classList.remove('hidden');
                        authorInitialsEl.style.display = 'none';
                    } else {
                        // Show initials if no image
                        const initials = publicName.split(' ').map(n => n[0]).join('').toUpperCase();
                        authorInitialsEl.textContent = initials;
                        authorInitialsEl.style.display = 'block';
                        authorImageEl.classList.add('hidden');
                    }
                } else {
                    // Author not found in database, hide section
                    document.getElementById('recipe-author-link').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading author data:', error);
                // Still show the author link but with username as fallback
                const authorLink = document.getElementById('recipe-author-link');
                authorLink.href = `konto.html?author=${encodeURIComponent(recipe.author)}`;
                document.getElementById('author-name').textContent = recipe.author;
                printAuthorData = { name: recipe.author, image: '' };
            }
        } else {
            document.getElementById('recipe-author-link').style.display = 'none';
            printAuthorData = { name: '', image: '' };
        }
        
    } catch (error) {
        console.error('Error loading recipe:', error);
        alert('Kunne ikke laste oppskriften. PrÃ¸v igjen senere.');
    }
}

// Load recipe when page loads
document.addEventListener('DOMContentLoaded', loadRecipe);
</script>
</body></html>